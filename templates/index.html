<!doctype html>
<html>
<head>
<title>Kali-LLM Task Manager</title>
<style>
*{box-sizing:border-box}
:root{
  --bg:#fff;--fg:#000;--card-bg:#fff;--card-border:#ddd;
  --input-bg:#fff;--input-border:#ccc;--status-bg:#f5f5f5;
  --tab-inactive:#666;--tab-active:#2196f3;--task-bg:#fff;
  --hover-bg:#f9f9f9;--grid-border:#e0e0e0;--badge-bg:#f5f5f5;
}
body.dark{
  --bg:#1a1a1a;--fg:#e0e0e0;--card-bg:#2d2d2d;--card-border:#444;
  --input-bg:#1a1a1a;--input-border:#555;--status-bg:#2d2d2d;
  --tab-inactive:#aaa;--tab-active:#64b5f6;--task-bg:#2d2d2d;
  --hover-bg:#3d3d3d;--grid-border:#444;--badge-bg:#3d3d3d;
}
body{font-family:Arial,sans-serif;margin:0;padding:1rem;height:100vh;overflow:hidden;background:var(--bg);color:var(--fg);transition:all 0.3s}
.container{display:flex;gap:20px;height:calc(100vh - 2rem)}
.left{flex:0 0 400px;display:flex;flex-direction:column;gap:10px}
.right{flex:1;display:flex;flex-direction:column;min-width:0}
.card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:8px;padding:15px}
.card h3{margin:0 0 10px 0;font-size:16px;color:var(--fg)}
textarea{width:100%;padding:8px;border:1px solid var(--input-border);border-radius:4px;font-family:inherit;resize:vertical;background:var(--input-bg);color:var(--fg)}
button{padding:8px 16px;border:none;border-radius:4px;cursor:pointer;font-size:14px;font-weight:500}
button:disabled{opacity:0.5;cursor:not-allowed}
.btn-primary{background:#2196f3;color:#fff}
.btn-success{background:#4caf50;color:#fff}
.btn-danger{background:#f44336;color:#fff}
.btn-warning{background:#ff9800;color:#fff}
button:hover:not(:disabled){opacity:0.9}
.btn-group{display:flex;gap:8px}
.tabs{display:flex;border-bottom:2px solid var(--grid-border);margin-bottom:10px}
.tab{padding:10px 20px;cursor:pointer;border-bottom:3px solid transparent;margin-bottom:-2px;font-weight:500;color:var(--tab-inactive)}
.tab.active{color:var(--tab-active);border-bottom-color:var(--tab-active)}
.tab-content{display:none;flex:1;overflow:auto}
.tab-content.active{display:flex;flex-direction:column}
.status{padding:10px;margin:10px 0;border-radius:4px;background:var(--status-bg);border-left:3px solid #2196f3}
.task{padding:12px;margin:8px 0;border:1px solid var(--card-border);border-radius:6px;border-left:4px solid #ccc;cursor:pointer;transition:all 0.2s;background:var(--task-bg)}
.task:hover{background:var(--hover-bg);transform:translateX(2px)}
.task.working{border-left-color:#ff9800}
.task.completed{border-left-color:#4caf50}
.task.failed{border-left-color:#f44336}
.task.planning{border-left-color:#2196f3}
.task-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.badge{padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;text-transform:uppercase;background:var(--badge-bg)}
.node{margin-left:30px;border-left-color:#999}
.controls{display:flex;gap:5px;margin-top:8px}
.controls button{padding:4px 10px;font-size:12px}
.file-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
.file-card{padding:20px;border:2px solid var(--grid-border);border-radius:8px;text-align:center;cursor:pointer;transition:all 0.2s;background:var(--card-bg)}
.file-card:hover{border-color:#2196f3;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.1)}
.file-card.dir{background:#e3f2fd}
.file-card.file{background:#fff3e0}
body.dark .file-card.dir{background:#1e3a5f}
body.dark .file-card.file{background:#3d2f1f}
.icon{font-size:36px;margin-bottom:8px}
.terminal{background:#000;color:#0f0;font-family:'Courier New',monospace;padding:15px;border-radius:6px;white-space:pre-wrap;overflow:auto;flex:1}
input[type=text]{padding:8px;border:1px solid var(--input-border);border-radius:4px;background:var(--input-bg);color:var(--fg)}
.toolbar{display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
.field{margin-bottom:12px}
.field label{display:block;font-weight:600;margin-bottom:4px;color:var(--fg)}
.field textarea{min-height:50px}
.field.description textarea{min-height:80px}
.viewer{background:var(--status-bg);padding:15px;border-radius:6px;margin-top:10px}
.viewer pre{background:var(--card-bg);padding:15px;border-radius:4px;overflow-x:auto;margin:10px 0;border:1px solid var(--card-border);color:var(--fg)}
.theme-toggle{position:fixed;top:20px;right:20px;z-index:1000;background:var(--card-bg);border:1px solid var(--card-border);border-radius:50%;width:50px;height:50px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:24px;box-shadow:0 2px 8px rgba(0,0,0,0.2)}
.theme-toggle:hover{transform:scale(1.1)}
</style>
</head>
<body>
<div class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">üåì</div>
<div class="container">
  <div class="left">
    <div class="card">
      <h3>üìù Task Input</h3>
      <textarea id="input" rows="6" placeholder="Example: Perform recon on domain example.com&#10;&#10;Press Enter or click Start to begin"></textarea>
      <div class="btn-group" style="margin-top:10px">
        <button class="btn-success" id="startBtn" onclick="handleStart()">‚ñ∂Ô∏è Start</button>
        <button class="btn-danger" onclick="handleReset()">üîÑ Reset</button>
      </div>
    </div>
    
    <div class="card" id="taskCard" style="display:none">
      <h3>‚úèÔ∏è Task Configuration</h3>
      <div class="field">
        <label>Abstract</label>
        <textarea id="abstract" readonly style="background:#f0f0f0"></textarea>
      </div>
      <div class="field description">
        <label>Description</label>
        <textarea id="description" readonly style="background:#f0f0f0"></textarea>
      </div>
      <div class="field">
        <label>Verification</label>
        <textarea id="verification" readonly style="background:#f0f0f0"></textarea>
      </div>
      <div class="btn-group" id="editBtns" style="display:none">
        <button class="btn-success" onclick="handleSave()">üíæ Save</button>
        <button class="btn-warning" onclick="handleCancel()">‚úñ Cancel</button>
      </div>
    </div>
    
    <div class="status" id="status"></div>
  </div>
  
  <div class="right card">
    <div class="tabs">
      <div class="tab active" onclick="switchTab(event,'tasks')">üìã Tasks</div>
      <div class="tab" onclick="switchTab(event,'graph')">üå≥ Graph</div>
      <div class="tab" onclick="switchTab(event,'terminal')">üíª Terminal</div>
      <div class="tab" onclick="switchTab(event,'llm')">ü§ñ LLM</div>
      <div class="tab" onclick="switchTab(event,'files')">üìÅ Files</div>
    </div>
    
    <div id="tasks" class="tab-content active">
      <div class="toolbar">
        <button class="btn-primary" onclick="loadTasks()">üîÑ Refresh</button>
        <span id="count"></span>
      </div>
      <div id="taskList"></div>
    </div>
    
    <div id="graph" class="tab-content">
      <div class="toolbar">
        <input type="text" id="graphId" placeholder="Task ID">
        <button class="btn-primary" onclick="loadGraph()">Load</button>
        <button id="graphAuto" class="btn-primary" onclick="toggleAuto('graph')">Auto: OFF</button>
      </div>
      <div id="graphView" style="flex:1;overflow:auto;background:#fafafa;padding:10px"></div>
    </div>
    
    <div id="terminal" class="tab-content">
      <div class="toolbar">
        <input type="text" id="termId" placeholder="Task ID">
        <button class="btn-primary" onclick="loadTerm()">Load</button>
        <button id="termAuto" class="btn-primary" onclick="toggleAuto('term')">Auto: OFF</button>
      </div>
      <div id="termView" class="terminal"></div>
    </div>
    
    <div id="llm" class="tab-content">
      <div class="toolbar">
        <input type="text" id="llmId" placeholder="Task ID">
        <button class="btn-primary" onclick="loadLLM()">Load</button>
        <button id="llmAuto" class="btn-primary" onclick="toggleAuto('llm')">Auto: OFF</button>
      </div>
      <div id="llmView" class="terminal" style="color:#ff0;background:#1a1a1a"></div>
    </div>
    
    <div id="files" class="tab-content">
      <div class="toolbar">
        <strong>üìÇ <span id="path">/app/work</span></strong>
        <button id="upBtn" class="btn-primary" onclick="goUp()" style="display:none">‚¨Ü Up</button>
      </div>
      <div id="fileGrid" class="file-grid"></div>
      <div id="fileView" class="viewer" style="display:none"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
mermaid.initialize({startOnLoad:false,theme:'default'});

// Global state
let task=null,orig=null,editing=false,curPath='/app/work',curTask=null;
let intervals={graph:null,term:null,llm:null,poll:null};
let auto={graph:false,term:false,llm:false};

function msg(t,c='#2196f3'){
  status.innerHTML=t;
  status.style.borderLeftColor=c;
}

// Enter key to start
document.addEventListener('DOMContentLoaded',()=>{
  input.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&!e.shiftKey){
      e.preventDefault();
      handleStart();
    }
  });
  loadTasks();
});

// Main start function - handles both translate and execute
async function handleStart(){
  console.log('handleStart called, task=', task);
  
  // Step 1: Translate if no task exists
  if(!task){
    const txt=input.value.trim();
    if(!txt){
      msg('‚ö† Enter a task description','#ff9800');
      return;
    }
    
    msg('üîÑ Translating task...');
    startBtn.disabled=true;
    
    try{
      console.log('Calling /translate with:', txt);
      const r=await fetch('/translate',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({request:txt})
      });
      const d=await r.json();
      console.log('Translation response:', d);
      
      if(d.error){
        startBtn.disabled=false;
        msg('‚ùå '+d.error,'#f44336');
        return;
      }
      
      task=d.translated_task;
      orig={...task};
      abstract.value=task.abstract;
      description.value=task.description;
      verification.value=task.verification;
      taskCard.style.display='block';
      startBtn.disabled=false;
      startBtn.innerHTML='‚ñ∂Ô∏è Execute Task';
      msg('‚úÖ Task translated! Click Start again to execute, or click fields to edit','#4caf50');
      
      // Make fields editable on click
      [abstract,description,verification].forEach(e=>{
        e.onclick=()=>{
          if(!editing){
            editing=true;
            [abstract,description,verification].forEach(f=>{
              f.readonly=false;
              f.style.background='#fff';
            });
            editBtns.style.display='flex';
            startBtn.disabled=true;
          }
        };
      });
      
    }catch(e){
      console.error('Translation error:', e);
      startBtn.disabled=false;
      msg('‚ùå '+e.message,'#f44336');
    }
    return;
  }
  
  // Step 2: Execute the task
  if(editing){
    msg('‚ö† Save changes first','#ff9800');
    return;
  }
  
  msg('‚è≥ Creating task...');
  startBtn.disabled=true;
  
  try{
    console.log('Creating task with:', task);
    const r=await fetch('/task',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({translated_task:task})
    });
    const d=await r.json();
    console.log('Task creation response:', d);
    
    if(d.error){
      startBtn.disabled=false;
      msg('‚ùå '+d.error,'#f44336');
      return;
    }
    
    curTask=d.task_id;
    graphId.value=termId.value=llmId.value=curTask;
    msg('‚úÖ Task '+curTask+' running','#4caf50');
    switchTab({target:document.querySelectorAll('.tab')[2]},'terminal');
    startAuto();
    loadTasks();
    
  }catch(e){
    console.error('Task creation error:', e);
    startBtn.disabled=false;
    msg('‚ùå '+e.message,'#f44336');
  }
}

function handleSave(){
  task={
    abstract:abstract.value.trim(),
    description:description.value.trim(),
    verification:verification.value.trim()
  };
  orig={...task};
  editing=false;
  [abstract,description,verification].forEach(e=>{
    e.readonly=true;
    e.style.background='#f0f0f0';
  });
  editBtns.style.display='none';
  startBtn.disabled=false;
  msg('üíæ Changes saved!','#4caf50');
}

function handleCancel(){
  abstract.value=orig.abstract;
  description.value=orig.description;
  verification.value=orig.verification;
  task={...orig};
  editing=false;
  [abstract,description,verification].forEach(e=>{
    e.readonly=true;
    e.style.background='#f0f0f0';
  });
  editBtns.style.display='none';
  startBtn.disabled=false;
  msg('‚ùå Changes cancelled');
}

function handleReset(){
  Object.values(intervals).forEach(i=>i&&clearInterval(i));
  task=orig=null;
  editing=false;
  curTask=null;
  input.value='';
  abstract.value='';
  description.value='';
  verification.value='';
  taskCard.style.display='none';
  startBtn.disabled=false;
  startBtn.innerHTML='‚ñ∂Ô∏è Start';
  msg('üîÑ Reset');
  fetch('/reset',{method:'POST'});
}

function switchTab(e,name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  e.target.classList.add('active');
  document.getElementById(name).classList.add('active');
  if(name==='files')loadFiles(curPath);
  else if(name==='tasks')loadTasks();
}

async function loadTasks(){
  try{
    const r=await fetch('/task/status');
    const d=await r.json();
    if(d.error)return taskList.innerHTML='<div style="color:#f44336;padding:20px">'+d.error+'</div>';
    const roots=d.tasks.filter(t=>t.type==='root');
    const nodes=d.tasks.filter(t=>t.type==='node');
    count.textContent=roots.length+' task(s), '+nodes.length+' node(s)';
    if(!roots.length)return taskList.innerHTML='<div style="color:#999;padding:40px;text-align:center">No tasks yet</div>';
    taskList.innerHTML='';
    roots.forEach(t=>{
      const div=document.createElement('div');
      div.className='task '+t.status;
      div.innerHTML=`<div class="task-header"><span style="font-family:monospace">üéØ ${t.task_id}</span><span class="badge">${t.status}</span></div><div style="font-weight:600">${t.abstract}</div>`;
      div.onclick=()=>viewTask(t.task_id);
      taskList.appendChild(div);
      nodes.filter(n=>n.task_id===t.task_id).forEach(n=>{
        const nd=document.createElement('div');
        nd.className='task node '+n.status;
        nd.innerHTML=`<div class="task-header"><span style="font-family:monospace">üì¶ ${n.node_id}</span><span class="badge">${n.status}</span></div><div>${n.abstract}</div><div class="controls"><button class="btn-primary" onclick="viewNode('${n.node_id}',event)">üëÅ</button><button class="btn-warning" onclick="stopNode('${n.node_id}',event)">‚è∏</button><button class="btn-danger" onclick="delNode('${n.node_id}',event)">üóë</button></div>`;
        taskList.appendChild(nd);
      });
    });
  }catch(e){taskList.innerHTML='<div style="color:#f44336">Error: '+e.message+'</div>'}
}

async function viewTask(id){
  graphId.value=termId.value=llmId.value=id;
  await loadGraph();
  const tabs=document.querySelectorAll('.tab');
  switchTab({target:tabs[1]},'graph');
}

async function viewNode(id,e){
  e.stopPropagation();
  try{
    const r=await fetch('/node/'+id);
    const d=await r.json();
    alert('Node: '+id+'\nStatus: '+d.status+'\nAbstract: '+d.abstract+'\n\nOutputs: '+d.terminal_output.length+'\nLLM: '+d.llm_responses.length);
  }catch(e){msg('‚ùå '+e.message,'#f44336')}
}

async function stopNode(id,e){
  e.stopPropagation();
  if(!confirm('Stop node '+id+'?'))return;
  try{
    const r=await fetch('/node/'+id+'/stop',{method:'PUT'});
    const d=await r.json();
    msg(d.error?'‚ùå '+d.error:'‚úÖ Stopped '+id,d.error?'#f44336':'#4caf50');
    loadTasks();
  }catch(e){msg('‚ùå '+e.message,'#f44336')}
}

async function delNode(id,e){
  e.stopPropagation();
  if(!confirm('Remove node '+id+'?'))return;
  try{
    const r=await fetch('/node/'+id+'/remove',{method:'DELETE'});
    const d=await r.json();
    msg(d.error?'‚ùå '+d.error:'‚úÖ Removed '+id,d.error?'#f44336':'#4caf50');
    loadTasks();
  }catch(e){msg('‚ùå '+e.message,'#f44336')}
}

async function loadGraph(){
  const id=graphId.value.trim();
  if(!id)return msg('‚ö† Enter task ID','#ff9800');
  try{
    const r=await fetch('/tree?task_id='+id);
    const d=await r.json();
    if(d.error)return graphView.innerHTML='<div style="color:#f44336;padding:20px">'+d.error+'</div>';
    graphView.innerHTML='<div class="mermaid">'+d.graph+'</div>';
    mermaid.init(undefined,graphView.querySelector('.mermaid'));
  }catch(e){graphView.innerHTML='<div style="color:#f44336">'+e.message+'</div>'}
}

async function loadTerm(){
  const id=termId.value.trim();
  if(!id)return msg('‚ö† Enter task ID','#ff9800');
  try{
    const r=await fetch('/task/'+id);
    const d=await r.json();
    termView.textContent=d.error?d.error:d.terminal_output&&d.terminal_output.length?d.terminal_output.join('\n'):'No output yet';
    termView.scrollTop=termView.scrollHeight;
  }catch(e){termView.textContent=e.message}
}

async function loadLLM(){
  const id=llmId.value.trim();
  if(!id)return msg('‚ö† Enter task ID','#ff9800');
  try{
    const r=await fetch('/task/'+id);
    const d=await r.json();
    llmView.textContent=d.error?d.error:d.llm_responses&&d.llm_responses.length?d.llm_responses.map((x,i)=>'['+(i+1)+'] '+x).join('\n\n'+'='.repeat(80)+'\n\n'):'No responses yet';
    llmView.scrollTop=llmView.scrollHeight;
  }catch(e){llmView.textContent=e.message}
}

function toggleAuto(type){
  auto[type]=!auto[type];
  const btn=document.getElementById(type+'Auto');
  btn.textContent='Auto: '+(auto[type]?'ON':'OFF');
  btn.className=auto[type]?'btn-success':'btn-primary';
  if(auto[type]){
    const id=document.getElementById(type+'Id').value.trim();
    if(!id)return;
    intervals[type]=setInterval(()=>type==='graph'?loadGraph():type==='term'?loadTerm():loadLLM(),3000);
  }else if(intervals[type]){
    clearInterval(intervals[type]);
    intervals[type]=null;
  }
}

function startAuto(){
  ['graph','term','llm'].forEach(t=>{
    auto[t]=true;
    const btn=document.getElementById(t+'Auto');
    btn.textContent='Auto: ON';
    btn.className='btn-success';
    intervals[t]=setInterval(()=>t==='graph'?loadGraph():t==='term'?loadTerm():loadLLM(),3000);
  });
  intervals.poll=setInterval(async()=>{
    try{
      const r=await fetch('/task/'+curTask);
      const d=await r.json();
      if(['completed','failed','cancelled','impossible'].includes(d.status)){
        Object.values(intervals).forEach(i=>i&&clearInterval(i));
        loadTerm();loadLLM();loadGraph();loadTasks();
        msg('‚úÖ Task '+d.status,d.status==='completed'?'#4caf50':'#f44336');
      }
    }catch(e){}
  },3000);
}

async function loadFiles(p){
  curPath=p;
  path.textContent=p;
  upBtn.style.display=(p!=='/app/work'&&p!=='/app'&&p!=='/')?'block':'none';
  fileView.style.display='none';
  try{
    const r=await fetch('/files?path='+encodeURIComponent(p));
    const d=await r.json();
    if(d.error)return fileGrid.innerHTML='<div style="grid-column:1/-1;color:#f44336">'+d.error+'</div>';
    if(!d.files.length)return fileGrid.innerHTML='<div style="grid-column:1/-1;text-align:center;color:#999;padding:40px">Empty</div>';
    fileGrid.innerHTML='';
    d.files.sort((a,b)=>a.type===b.type?a.name.localeCompare(b.name):a.type==='directory'?-1:1).forEach(f=>{
      const c=document.createElement('div');
      c.className='file-card '+(f.type==='directory'?'dir':'file');
      const icon=f.type==='directory'?'üìÅ':f.name.endsWith('.txt')?'üìÑ':f.name.endsWith('.log')?'üìã':f.name.endsWith('.json')?'üìä':'üìÑ';
      c.innerHTML='<div class="icon">'+icon+'</div><div style="font-weight:600;font-size:13px;word-break:break-word">'+f.name+'</div><div style="font-size:11px;color:#666;margin-top:5px">'+f.size+'</div>';
      c.onclick=()=>f.type==='directory'?loadFiles(f.full_path):viewFile(f.full_path);
      fileGrid.appendChild(c);
    });
  }catch(e){fileGrid.innerHTML='<div style="grid-column:1/-1;color:#f44336">'+e.message+'</div>'}
}

function goUp(){
  loadFiles(curPath.split('/').slice(0,-1).join('/')||'/');
}

async function viewFile(p){
  fileView.style.display='block';
  fileView.innerHTML='<div style="text-align:center;color:#999">Loading...</div>';
  try{
    const r=await fetch('/file?path='+encodeURIComponent(p));
    const d=await r.json();
    if(d.error)return fileView.innerHTML='<div style="color:#f44336">'+d.error+'</div>';
    const name=p.split('/').pop();
    fileView.innerHTML='<h3>üìÑ '+name+'</h3><button class="btn-primary" onclick="copyFile()">üìã Copy</button> <button class="btn-danger" onclick="fileView.style.display=\'none\'">‚úñ Close</button><pre id="fc">'+esc(d.content)+'</pre>';
  }catch(e){fileView.innerHTML='<div style="color:#f44336">'+e.message+'</div>'}
}

function copyFile(){
  navigator.clipboard.writeText(fc.textContent).then(()=>msg('üìã Copied!','#4caf50')).catch(()=>msg('‚ùå Copy failed','#f44336'));
}

function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}
</script>
</body>
</html>