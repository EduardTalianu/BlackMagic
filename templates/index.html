<!doctype html>
<title>Kali-LLM</title>
<style>
body{font-family:Arial;margin:1rem;height:95vh}
.container{display:flex;gap:20px;height:100%}
.left-column{flex:1;display:flex;flex-direction:column;max-width:400px}
.right-column{flex:3;display:flex;flex-direction:column}
textarea{width:100%;resize:none;margin-bottom:10px}
button{margin:5px 0;padding:5px 10px;width:100%}
#status{margin:10px 0;font-weight:bold}
h2{margin-top:0}
.tabs{display:flex;border-bottom:1px solid #ccc}
.tab{padding:10px 15px;cursor:pointer;background:#f1f1f1;border:1px solid #ccc;border-bottom:none;margin-right:5px}
.tab.active{background:#fff;border-bottom:1px solid #fff;margin-bottom:-1px}
.tab-content{display:none;padding:10px;border:1px solid #ccc;border-top:none;flex:1;overflow-y:auto}
.tab-content.active{display:flex;flex-direction:column}
#terminal{background:#000;color:#0f0;font-family:monospace;white-space:pre-wrap}
#llm_response{background:#1a1a1a;color:#ff0;font-family:monospace;white-space:pre-wrap}
#work_dir{background:#f9f9f9;font-family:monospace;white-space:pre-wrap}
.file-item{padding:5px;border-bottom:1px solid #eee;cursor:pointer}
.file-item:hover{background:#f0f0f0}
.file-item.directory{font-weight:bold}
.file-actions{display:flex;gap:10px;margin-top:5px}
.file-actions button{padding:2px 8px;font-size:12px;width:auto}
.file-content{background:#f5f5f5;padding:10px;margin-top:5px;border:1px solid #ddd}
.input-container{flex:1;display:flex;flex-direction:column}
.controls-container{display:flex;gap:10px;margin-top:10px}
.controls-container button{flex:1}
.log-controls{margin-top:10px}
.info-box{background:#e8f4f8;padding:10px;margin-bottom:10px;border-radius:5px}
.path-nav{background:#f0f0f0;padding:5px;margin-bottom:10px;border-radius:5px}
.path-nav button{padding:2px 8px;font-size:12px;width:auto;margin:0 2px}
.shared-info{background:#e8f8e8;padding:10px;margin-bottom:10px;border-radius:5px}
.config-section{background:#fff3cd;padding:10px;margin-bottom:10px;border-radius:5px;border:1px solid #ffc107}
.config-controls{display:flex;gap:10px;align-items:center;margin-top:5px}
.config-controls input{padding:5px;width:80px}
.config-controls button{padding:5px 15px;width:auto}
.countdown{color:#666;font-size:0.9em;font-style:italic}
.translation-section{background:#e3f2fd;padding:10px;margin-bottom:10px;border-radius:5px;border:1px solid #2196f3;display:none}
.translation-section.active{display:block}
.translation-content{background:#fff;padding:10px;margin-top:10px;border-radius:5px;border:1px solid #ccc;max-height:200px;overflow-y:auto}
.translation-field{margin-bottom:10px}
.translation-field strong{display:block;color:#1976d2;margin-bottom:5px}
.translation-field div{color:#424242;white-space:pre-wrap}
#askInput{height:120px}
.workflow-status{background:#f5f5f5;padding:8px;margin:10px 0;border-left:3px solid #2196f3;font-size:0.9em}
</style>
<div class="container">
  <div class="left-column">
    <h2>Task Input</h2>
    <div class="config-section">
      <strong>Auto-Continue Settings</strong>
      <div class="config-controls">
        <label>Delay (seconds):</label>
        <input type="number" id="delayInput" value="10" min="1" max="60">
        <button id="updateConfig" style="width:auto">Update</button>
      </div>
    </div>
    <div class="translation-section" id="translationSection">
      <strong>üìã Translated Task</strong>
      <div class="translation-content" id="translationContent">
        <div class="translation-field">
          <strong>Abstract:</strong>
          <div id="taskAbstract"></div>
        </div>
        <div class="translation-field">
          <strong>Description:</strong>
          <div id="taskDescription"></div>
        </div>
        <div class="translation-field">
          <strong>Verification:</strong>
          <div id="taskVerification"></div>
        </div>
      </div>
    </div>
    <div class="input-container">
      <form id="form">
        <label>What do you want to accomplish?</label><br>
        <textarea id="askInput" placeholder="Example:&#10;1. Perform passive recon on domain example.com&#10;2. Scan a web application for vulnerabilities&#10;3. Enumerate SMB shares on 192.168.1.0/24"></textarea><br>
        <div class="controls-container">
          <button type="button" id="translateBtn">Translate Task</button>
          <button type="submit" id="startBtn" disabled>Start Execution</button>
          <button type="button" id="continue" style="display:none">Continue</button>
          <button type="button" id="reset">Reset</button>
        </div>
      </form>
      <div class="workflow-status" id="workflowStatus" style="display:none"></div>
      <div id="status"></div>
    </div>
  </div>
  <div class="right-column">
    <h2>Output</h2>
    <div class="tabs">
      <div class="tab active" data-tab="terminal">Terminal</div>
      <div class="tab" data-tab="llm_response">LLM Response</div>
      <div class="tab" data-tab="work_dir">Work Directory</div>
    </div>
    <div id="terminal" class="tab-content active"></div>
    <div id="llm_response" class="tab-content"></div>
    <div id="work_dir" class="tab-content">
      <div class="shared-info">
        <strong>Shared Directories:</strong>
        <div id="sharedInfo">Loading...</div>
      </div>
      <div class="path-nav">
        <span id="currentPath">/app</span>
        <button id="parentDirBtn" style="display:none">‚Üë Parent</button>
      </div>
      <div id="file_list">Loading...</div>
      <div id="file_content"></div>
    </div>
  </div>
</div>
<script>
const terminal=document.getElementById('terminal');
const llm_response=document.getElementById('llm_response');
const work_dir=document.getElementById('work_dir');
const file_list=document.getElementById('file_list');
const file_content=document.getElementById('file_content');
const status=document.getElementById('status');
const form=document.getElementById('form');
const startBtn=document.getElementById('startBtn');
const continueBtn=document.getElementById('continue');
const resetBtn=document.getElementById('reset');
const currentPath=document.getElementById('currentPath');
const parentDirBtn=document.getElementById('parentDirBtn');
const sharedInfo=document.getElementById('sharedInfo');
const delayInput=document.getElementById('delayInput');
const updateConfig=document.getElementById('updateConfig');
const askInput=document.getElementById('askInput');
const translateBtn=document.getElementById('translateBtn');
const translationSection=document.getElementById('translationSection');
const taskAbstract=document.getElementById('taskAbstract');
const taskDescription=document.getElementById('taskDescription');
const taskVerification=document.getElementById('taskVerification');
const workflowStatus=document.getElementById('workflowStatus');

let currentDirPath = '/app';
let autoContDelay = 10;
let countdownTimer = null;
let countdownSeconds = 0;
let translatedTask = null;

// Load configuration on startup
async function loadConfig(){
  try {
    const r=await fetch('/config');
    const data=await r.json();
    autoContDelay=data.auto_continue_delay;
    delayInput.value=autoContDelay;
  } catch (e) {
    console.error('Failed to load config:', e);
  }
}

// Update configuration
updateConfig.onclick=async()=>{
  try {
    const newDelay=parseInt(delayInput.value);
    if(newDelay < 1 || newDelay > 60){
      alert('Delay must be between 1 and 60 seconds');
      return;
    }
    const r=await fetch('/config',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({auto_continue_delay:newDelay})
    });
    const data=await r.json();
    autoContDelay=data.auto_continue_delay;
    status.textContent=`‚úì Auto-continue delay updated to ${autoContDelay} seconds`;
  } catch (e) {
    status.textContent=`‚úó Failed to update config: ${e.message}`;
  }
};

// Tab functionality
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
    
    // Load files when work directory tab is clicked
    if (tab.dataset.tab === 'work_dir') {
      loadSharedInfo();
      loadFiles(currentDirPath);
    }
  });
});

// Enter key support
askInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && e.ctrlKey) {
    e.preventDefault();
    if(translatedTask){
      startTask();
    } else {
      translateTask();
    }
  }
});

// Translate button handler
translateBtn.onclick=async()=>{
  await translateTask();
};

form.onsubmit=async(e)=>{
  e.preventDefault();
  if(translatedTask){
    await startTask();
  } else {
    status.textContent='‚ö†Ô∏è Please translate the task first';
  }
};

continueBtn.onclick=async()=>{
  clearCountdown();
  await continueTask();
};

resetBtn.onclick=async()=>{
  clearCountdown();
  await fetch('/reset',{method:'POST'});
  terminal.textContent='';
  llm_response.textContent='';
  status.textContent='Session reset. Ready for new task.';
  workflowStatus.style.display='none';
  continueBtn.style.display='none';
  startBtn.disabled = true;
  translatedTask = null;
  translationSection.classList.remove('active');
  translateBtn.disabled = false;
};

parentDirBtn.onclick=async()=>{
  if(currentDirPath !== '/'){
    const parentPath = currentDirPath.split('/').slice(0, -1).join('/') || '/';
    await navigateToDirectory(parentPath);
  }
};

function clearCountdown(){
  if(countdownTimer){
    clearInterval(countdownTimer);
    countdownTimer=null;
  }
}

function startCountdown(seconds, callback){
  clearCountdown();
  countdownSeconds=seconds;
  
  const updateStatus=()=>{
    if(countdownSeconds > 0){
      status.innerHTML=`‚è∏Ô∏è Task in progress... <span class="countdown">Auto-continuing in ${countdownSeconds}s</span>`;
      countdownSeconds--;
    } else {
      clearCountdown();
      callback();
    }
  };
  
  updateStatus();
  countdownTimer=setInterval(updateStatus, 1000);
}

async function translateTask(){
  const userRequest=askInput.value.trim();
  if(!userRequest) {
    status.textContent='‚ö†Ô∏è Please enter a task description';
    return;
  }
  
  translateBtn.disabled = true;
  status.textContent='üîÑ Translating task...';
  workflowStatus.style.display='block';
  workflowStatus.textContent='Step 1/2: Translating user request into structured task...';
  
  try {
    const r=await fetch('/translate',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({request:userRequest})
    });
    
    const data=await r.json();
    
    if(data.error){
      status.textContent=`‚ùå Translation failed: ${data.error}`;
      workflowStatus.style.display='none';
      translateBtn.disabled = false;
      return;
    }
    
    // Store translated task
    translatedTask = data.translated_task;
    
    // Display translated task
    taskAbstract.textContent = translatedTask.abstract;
    taskDescription.textContent = translatedTask.description;
    taskVerification.textContent = translatedTask.verification;
    translationSection.classList.add('active');
    
    // Enable start button
    startBtn.disabled = false;
    status.textContent='‚úÖ Task translated successfully! Click "Start Execution" to begin.';
    workflowStatus.textContent='Step 1/2: ‚úì Task translated. Ready for execution.';
    
  } catch (e) {
    status.textContent=`‚ùå Translation error: ${e.message}`;
    workflowStatus.style.display='none';
    translateBtn.disabled = false;
  }
}

async function loadSharedInfo(){
  try {
    const r=await fetch('/shared_info');
    const data=await r.json();
    
    if(data.error){
      sharedInfo.textContent=`Error: ${data.error}`;
      return;
    }
    
    sharedInfo.innerHTML=`
      <div>Container Work Dir: ${data.work_directory}</div>
      <div>Container Logs Dir: ${data.logs_directory}</div>
      <div>Host Work Dir: ${data.host_work_directory}</div>
      <div>Host Logs Dir: ${data.host_logs_directory}</div>
    `;
  } catch (e) {
    sharedInfo.textContent=`Error loading shared info: ${e.message}`;
  }
}

async function navigateToDirectory(path){
  currentDirPath = path;
  currentPath.textContent = path;
  parentDirBtn.style.display = path === '/' ? 'none' : 'inline-block';
  await loadFiles(path);
}

async function startTask(){
  if(!translatedTask){
    status.textContent='‚ö†Ô∏è Please translate the task first';
    return;
  }
  
  clearCountdown();
  terminal.textContent='';
  llm_response.textContent='';
  status.textContent='‚è≥ Processing...';
  workflowStatus.style.display='block';
  workflowStatus.textContent='Step 2/2: Executing task...';
  continueBtn.style.display='none';
  startBtn.disabled = true;
  translateBtn.disabled = true;
  
  const r=await fetch('/run',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      ask:askInput.value.trim(),
      translated_task:translatedTask
    })
  });
  const data=await r.json();
  updateUI(data);
}

async function continueTask(){
  status.textContent='‚è≥ Processing...';
  continueBtn.style.display='none';
  
  const r=await fetch('/run',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({continue:true})
  });
  const data=await r.json();
  updateUI(data);
}

function updateUI(data){
  if(data.error){
    clearCountdown();
    terminal.textContent+=`\n‚ùå Error: ${data.error}`;
    status.textContent='‚ùå Task failed';
    startBtn.disabled = false;
    return;
  }
  
  terminal.textContent+=data.output+'\n\n';
  llm_response.textContent=data.llm_response || '';
  
  if(data.done){
    clearCountdown();
    // Move the completion message to the LLM response area
    if(data.summary){
      llm_response.textContent+=`\n\n‚úÖ Task completed: ${data.summary}`;
    }
    status.textContent='‚úÖ Task completed';
    workflowStatus.textContent='Step 2/2: ‚úì Task execution completed successfully!';
    continueBtn.style.display='none';
    startBtn.disabled = true;
    translateBtn.disabled = false;
    translatedTask = null;
  } else {
    const delay=data.auto_continue_delay || autoContDelay;
    continueBtn.style.display='inline-block';
    workflowStatus.textContent='Step 2/2: Task execution in progress...';
    
    if(data.auto_continue){
      startCountdown(delay, continueTask);
    } else {
      status.textContent='‚è∏Ô∏è Task in progress... (click Continue)';
    }
  }
}

async function loadFiles(path){
  file_list.textContent='Loading...';
  file_content.innerHTML='';
  
  try {
    const r=await fetch(`/files?path=${encodeURIComponent(path)}`);
    const data=await r.json();
    
    if(data.error){
      file_list.textContent=`Error: ${data.error}`;
      return;
    }
    
    file_list.innerHTML='';
    
    if(data.files.length === 0){
      file_list.textContent='No files in this directory';
      return;
    }
    
    data.files.forEach(file => {
      const fileItem=document.createElement('div');
      fileItem.className=`file-item ${file.type}`;
      fileItem.innerHTML=`
        <div>${file.type === 'directory' ? 'üìÅ' : 'üìÑ'} ${file.name}</div>
        <div>Size: ${file.size} | Permissions: ${file.permissions}</div>
        <div class="file-actions">
          <button onclick="copyPath('${file.full_path}')">Copy Path</button>
          ${file.type === 'directory' ? `<button onclick="navigateToDirectory('${file.full_path}')">Enter</button>` : `<button onclick="viewFile('${file.full_path}')">View Content</button>`}
        </div>
      `;
      file_list.appendChild(fileItem);
    });
  } catch (e) {
    file_list.textContent=`Error loading files: ${e.message}`;
  }
}

function copyPath(path){
  navigator.clipboard.writeText(path).then(() => {
    status.textContent=`Copied path: ${path}`;
  }).catch(err => {
    status.textContent=`Failed to copy path: ${err}`;
  });
}

async function viewFile(path){
  file_content.innerHTML=`Loading content of ${path}...`;
  
  try {
    const r=await fetch(`/file?path=${encodeURIComponent(path)}`);
    const data=await r.json();
    
    if(data.error){
      file_content.innerHTML=`Error: ${data.error}`;
      return;
    }
    
    const contentDiv=document.createElement('div');
    contentDiv.className='file-content';
    contentDiv.innerHTML=`
      <h3>${path}</h3>
      <div style="display:flex;justify-content:space-between;margin-bottom:10px">
        <button onclick="copyFileContent('${path}')">Copy Content</button>
        <button onclick="file_content.innerHTML=''">Close</button>
      </div>
      <pre>${data.content}</pre>
    `;
    file_content.innerHTML='';
    file_content.appendChild(contentDiv);
  } catch (e) {
    file_content.innerHTML=`Error loading file: ${e.message}`;
  }
}

function copyFileContent(path){
  const content=document.querySelector('#file_content pre').textContent;
  navigator.clipboard.writeText(content).then(() => {
    status.textContent=`Copied content of ${path}`;
  }).catch(err => {
    status.textContent=`Failed to copy content: ${err}`;
  });
}

// Load configuration and files on page load
window.addEventListener('load', () => {
  loadConfig();
  // Auto-switch to terminal tab on load
  document.querySelector('.tab[data-tab="terminal"]').click();
});
</script>
</document_content>
</invoke>