<!doctype html>
<html>
<head>
<title>Kali-LLM Task Manager</title>
<style>
*{box-sizing:border-box}
:root{
  --bg:#1a1a1a;--fg:#e0e0e0;--card-bg:#2d2d2d;--card-border:#444;
  --input-bg:#1a1a1a;--input-border:#555;--status-bg:#2d2d2d;
  --tab-inactive:#aaa;--tab-active:#64b5f6;--task-bg:#2d2d2d;
  --hover-bg:#3d3d3d;--grid-border:#444;--badge-bg:#3d3d3d;
}
body{font-family:Arial,sans-serif;margin:0;padding:1rem;height:100vh;overflow:hidden;background:var(--bg);color:var(--fg);transition:all 0.3s}
.container{display:flex;gap:20px;height:calc(100vh - 2rem)}
.left{flex:0 0 400px;display:flex;flex-direction:column;gap:10px}
.right{flex:1;display:flex;flex-direction:column;min-width:0}
.card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:8px;padding:15px}
.card h3{margin:0 0 10px 0;font-size:16px;color:var(--fg)}
textarea{width:100%;padding:8px;border:1px solid var(--input-border);border-radius:4px;font-family:inherit;resize:vertical;background:var(--input-bg);color:var(--fg)}
textarea:focus{outline:none;border-color:#64b5f6}
button{padding:8px 16px;border:none;border-radius:4px;cursor:pointer;font-size:14px;font-weight:500}
button:disabled{opacity:0.5;cursor:not-allowed}
.btn-primary{background:#2196f3;color:#fff}
.btn-success{background:#4caf50;color:#fff}
.btn-danger{background:#f44336;color:#fff}
.btn-warning{background:#ff9800;color:#fff}
.btn-info{background:#00bcd4;color:#fff}
button:hover:not(:disabled){opacity:0.9}
.btn-group{display:flex;gap:8px}
.tabs{display:flex;border-bottom:2px solid var(--grid-border);margin-bottom:10px}
.tab{padding:10px 20px;cursor:pointer;border-bottom:3px solid transparent;margin-bottom:-2px;font-weight:500;color:var(--tab-inactive)}
.tab.active{color:var(--tab-active);border-bottom-color:var(--tab-active)}
.tab-content{display:none;flex:1;overflow:auto}
.tab-content.active{display:flex;flex-direction:column}
.status{padding:10px;margin:10px 0;border-radius:4px;background:var(--status-bg);border-left:3px solid #2196f3}
.task{padding:12px;margin:8px 0;border:1px solid var(--card-border);border-radius:6px;border-left:4px solid #ccc;cursor:pointer;transition:all 0.2s;background:var(--task-bg)}
.task:hover{background:var(--hover-bg);transform:translateX(2px)}
.task.working{border-left-color:#ff9800}
.task.completed{border-left-color:#4caf50}
.task.failed{border-left-color:#f44336}
.task.planning{border-left-color:#2196f3}
.task.cancelled{border-left-color:#9e9e9e}
.task.impossible{border-left-color:#9c27b0}
.task-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.badge{padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;text-transform:uppercase;background:var(--badge-bg)}
.node{margin-left:30px;border-left-color:#999}
.controls{display:flex;gap:5px;margin-top:8px;flex-wrap:wrap}
.controls button{padding:4px 10px;font-size:12px}
.file-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
.file-card{padding:20px;border:2px solid var(--grid-border);border-radius:8px;text-align:center;cursor:pointer;transition:all 0.2s;background:var(--card-bg)}
.file-card:hover{border-color:#2196f3;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.3)}
.file-card.dir{background:#1e3a5f}
.file-card.file{background:#3d2f1f}
.icon{font-size:36px;margin-bottom:8px}
.terminal{background:#000;color:#0f0;font-family:'Courier New',monospace;padding:15px;border-radius:6px;white-space:pre-wrap;overflow:auto;flex:1}
.terminal::before{content:'';display:block}
#outputView{color:#e0e0e0}
input[type=text]{padding:8px;border:1px solid var(--input-border);border-radius:4px;background:var(--input-bg);color:var(--fg)}
input[type=text]:focus{outline:none;border-color:#64b5f6}
select{padding:8px;border:1px solid var(--input-border);border-radius:4px;background:var(--input-bg);color:var(--fg);font-size:14px;min-width:200px}
select:focus{outline:none;border-color:#64b5f6}
option{background:var(--card-bg);color:var(--fg);padding:8px}
option.depth-1{padding-left:20px}
option.depth-2{padding-left:40px}
option.depth-3{padding-left:60px}
option.depth-4{padding-left:80px}
.toolbar{display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
.field{margin-bottom:12px}
.field label{display:block;font-weight:600;margin-bottom:4px;color:var(--fg)}
.field textarea{min-height:50px}
.field.description textarea{min-height:80px}
.viewer{background:var(--status-bg);padding:15px;border-radius:6px;margin-top:10px}
.viewer pre{background:var(--card-bg);padding:15px;border-radius:4px;overflow-x:auto;margin:10px 0;border:1px solid var(--card-border);color:var(--fg)}
.quick-nav{display:flex;gap:10px;margin-bottom:10px}
.quick-nav button{padding:6px 12px;font-size:13px}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:var(--card-bg);border:1px solid var(--card-border);border-radius:8px;padding:20px;max-width:500px;width:90%}
.modal-content h3{margin:0 0 15px 0}
.modal-content textarea{min-height:100px;margin-bottom:15px}
.modal-buttons{display:flex;gap:10px;justify-content:flex-end}
</style>
</head>
<body>
<div class="container">
  <div class="left">
    <div class="card">
      <h3>📝 Task Input</h3>
      <textarea id="input" rows="6" placeholder="Example: Perform recon on domain example.com&#10;&#10;Press Enter or click Start to begin"></textarea>
      <div class="btn-group" style="margin-top:10px">
        <button class="btn-success" id="startBtn">▶️ Start</button>
        <button class="btn-danger" id="resetBtn">🔄 Reset</button>
      </div>
    </div>
    
    <div class="card" id="taskCard" style="display:none">
      <h3>✏️ Task Configuration</h3>
      <div class="field">
        <label>Abstract</label>
        <textarea id="abstract"></textarea>
      </div>
      <div class="field description">
        <label>Description</label>
        <textarea id="description"></textarea>
      </div>
      <div class="field">
        <label>Verification</label>
        <textarea id="verification"></textarea>
      </div>
    </div>
    
    <div class="status" id="status"></div>
  </div>
  
  <div class="right card">
    <div class="tabs">
      <div class="tab active" data-tab="tasks">📋 Tasks</div>
      <div class="tab" data-tab="graph">🌳 Graph</div>
      <div class="tab" data-tab="output">📟 Output</div>
      <div class="tab" data-tab="files">📁 Files</div>
    </div>
    
    <div id="tasks" class="tab-content active">
      <div class="toolbar">
        <button class="btn-primary" id="refreshTasksBtn">🔄 Refresh</button>
        <span id="count"></span>
      </div>
      <div id="taskList"></div>
    </div>
    
    <div id="graph" class="tab-content">
      <div class="toolbar">
        <input type="text" id="graphId" placeholder="Task ID">
        <button class="btn-primary" id="loadGraphBtn">Load</button>
        <button id="graphAuto" class="btn-primary">Auto: OFF</button>
      </div>
      <div id="graphView" style="flex:1;overflow:auto;background:#1a1a1a;padding:10px"></div>
    </div>
    
    <div id="output" class="tab-content">
      <div class="toolbar">
        <input type="text" id="outputTaskId" placeholder="Task ID" style="width:150px">
        <select id="outputNodeSelect" style="flex:1;max-width:400px">
          <option value="">Select task first...</option>
        </select>
        <button class="btn-primary" id="loadOutputBtn">🔄 Refresh</button>
        <button id="outputAuto" class="btn-primary">Auto: OFF</button>
      </div>
      <div id="outputView" class="terminal"></div>
    </div>
    
    <div id="files" class="tab-content">
      <div class="quick-nav">
        <button class="btn-primary" id="navWork">📂 Work</button>
        <button class="btn-primary" id="navLogs">📋 Logs</button>
        <button class="btn-primary" id="navShared">🔗 Shared</button>
      </div>
      <div class="toolbar">
        <strong>📂 <span id="path">/app/work</span></strong>
        <button id="upBtn" class="btn-primary" style="display:none">⬆ Up</button>
      </div>
      <div id="fileGrid" class="file-grid"></div>
      <div id="fileView" class="viewer" style="display:none"></div>
    </div>
  </div>
</div>

<!-- Modal for task improvement comments -->
<div id="improveTaskModal" class="modal">
  <div class="modal-content">
    <h3>💡 Improve Task with Comments</h3>
    <p style="margin:0 0 10px 0;color:#aaa">Provide improvement notes that will be added to the task description:</p>
    <textarea id="improveTaskComments" placeholder="Example: Try using different tools like dnsenum instead of subfinder. Focus on finding subdomains with HTTPS enabled."></textarea>
    <div class="modal-buttons">
      <button class="btn-danger" id="improveTaskCancelBtn">Cancel</button>
      <button class="btn-success" id="improveTaskSubmitBtn">🚀 Restart with Improvements</button>
    </div>
  </div>
</div>

<!-- Modal for node improvement comments -->
<div id="improveNodeModal" class="modal">
  <div class="modal-content">
    <h3>💡 Improve Node with Comments</h3>
    <p style="margin:0 0 10px 0;color:#aaa">Provide improvement notes for this specific node:</p>
    <textarea id="improveNodeComments" placeholder="Example: Use more aggressive scanning options. Check for additional ports beyond the standard ones."></textarea>
    <div class="modal-buttons">
      <button class="btn-danger" id="improveNodeCancelBtn">Cancel</button>
      <button class="btn-success" id="improveNodeSubmitBtn">🚀 Restart Node with Improvements</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
mermaid.initialize({startOnLoad:false,theme:'dark'});

// Global state
let task=null,orig=null,curPath='/app/work',curTask=null;
let intervals={graph:null,output:null,poll:null,outputNodes:null};
let auto={graph:false,output:false};
let nodeCache={};
let improveTaskId=null;
let improveNodeId=null;

// DOM element references
let input, status, startBtn, resetBtn, taskCard, abstract, description, verification;
let graphId, outputTaskId, outputNodeSelect;
let graphView, outputView, fileGrid, fileView, path, upBtn, taskList, count;
let refreshTasksBtn, loadGraphBtn, loadOutputBtn, graphAuto, outputAuto;
let navWork, navLogs, navShared;
let improveTaskModal, improveTaskComments, improveTaskCancelBtn, improveTaskSubmitBtn;
let improveNodeModal, improveNodeComments, improveNodeCancelBtn, improveNodeSubmitBtn;

function msg(t,c='#2196f3'){
  if(!status) return;
  status.innerHTML=t;
  status.style.borderLeftColor=c;
}

// Initialize on DOM load
document.addEventListener('DOMContentLoaded',()=>{
  console.log('DOM loaded, initializing...');
  
  // Initialize all element references
  input = document.getElementById('input');
  status = document.getElementById('status');
  startBtn = document.getElementById('startBtn');
  resetBtn = document.getElementById('resetBtn');
  taskCard = document.getElementById('taskCard');
  abstract = document.getElementById('abstract');
  description = document.getElementById('description');
  verification = document.getElementById('verification');
  graphId = document.getElementById('graphId');
  outputTaskId = document.getElementById('outputTaskId');
  outputNodeSelect = document.getElementById('outputNodeSelect');
  graphView = document.getElementById('graphView');
  outputView = document.getElementById('outputView');
  fileGrid = document.getElementById('fileGrid');
  fileView = document.getElementById('fileView');
  path = document.getElementById('path');
  upBtn = document.getElementById('upBtn');
  taskList = document.getElementById('taskList');
  count = document.getElementById('count');
  refreshTasksBtn = document.getElementById('refreshTasksBtn');
  loadGraphBtn = document.getElementById('loadGraphBtn');
  loadOutputBtn = document.getElementById('loadOutputBtn');
  graphAuto = document.getElementById('graphAuto');
  outputAuto = document.getElementById('outputAuto');
  navWork = document.getElementById('navWork');
  navLogs = document.getElementById('navLogs');
  navShared = document.getElementById('navShared');
  improveTaskModal = document.getElementById('improveTaskModal');
  improveTaskComments = document.getElementById('improveTaskComments');
  improveTaskCancelBtn = document.getElementById('improveTaskCancelBtn');
  improveTaskSubmitBtn = document.getElementById('improveTaskSubmitBtn');
  improveNodeModal = document.getElementById('improveNodeModal');
  improveNodeComments = document.getElementById('improveNodeComments');
  improveNodeCancelBtn = document.getElementById('improveNodeCancelBtn');
  improveNodeSubmitBtn = document.getElementById('improveNodeSubmitBtn');
  
  console.log('Elements initialized');
  
  // Add event listeners
  input.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&!e.shiftKey){
      e.preventDefault();
      handleStart();
    }
  });
  
  startBtn.addEventListener('click', handleStart);
  resetBtn.addEventListener('click', handleReset);
  refreshTasksBtn.addEventListener('click', loadTasks);
  loadGraphBtn.addEventListener('click', loadGraph);
  loadOutputBtn.addEventListener('click', loadOutput);
  graphAuto.addEventListener('click', ()=>toggleAuto('graph'));
  outputAuto.addEventListener('click', ()=>toggleAuto('output'));
  upBtn.addEventListener('click', goUp);
  navWork.addEventListener('click', ()=>loadFiles('/app/work'));
  navLogs.addEventListener('click', ()=>loadFiles('/app/logs'));
  navShared.addEventListener('click', ()=>loadFiles('/shared'));
  
  // Task improvement modal
  improveTaskCancelBtn.addEventListener('click', ()=>{improveTaskModal.classList.remove('active');improveTaskId=null;});
  improveTaskSubmitBtn.addEventListener('click', submitTaskImprovement);
  
  // Node improvement modal
  improveNodeCancelBtn.addEventListener('click', ()=>{improveNodeModal.classList.remove('active');improveNodeId=null;});
  improveNodeSubmitBtn.addEventListener('click', submitNodeImprovement);
  
  // Task ID change listeners for dropdowns
  outputTaskId.addEventListener('change', loadOutputNodes);
  
  // Node selection change listeners
  outputNodeSelect.addEventListener('change', loadOutput);
  
  // Tab switching
  document.querySelectorAll('.tab').forEach(tab=>{
    tab.addEventListener('click', function(){
      const tabName = this.getAttribute('data-tab');
      switchTab(tabName);
    });
  });
  
  console.log('Event listeners attached');
  msg('Ready to start');
  loadTasks();
});

function switchTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${name}"]`).classList.add('active');
  document.getElementById(name).classList.add('active');
  if(name==='files')loadFiles(curPath);
  else if(name==='tasks')loadTasks();
}

// Node dropdown population
async function loadOutputNodes(){
  const taskId = outputTaskId.value.trim();
  if(!taskId){
    outputNodeSelect.innerHTML='<option value="">Select task first...</option>';
    return;
  }
  
  const currentSelection = outputNodeSelect.value;
  const hadSelection = currentSelection && currentSelection !== '';
  
  try{
    const r = await fetch('/task/'+taskId+'/nodes');
    const d = await r.json();
    
    if(d.error){
      outputNodeSelect.innerHTML='<option value="">Error loading nodes</option>';
      return;
    }
    
    nodeCache[taskId] = d.nodes;
    populateNodeDropdown(outputNodeSelect, d.nodes);
    
    if(hadSelection){
      const optionExists = Array.from(outputNodeSelect.options).some(opt => opt.value === currentSelection);
      if(optionExists){
        outputNodeSelect.value = currentSelection;
      }
    } else if(d.nodes.length > 0) {
      outputNodeSelect.value = d.nodes[0].node_id;
      await loadOutput();
    }
    
  }catch(e){
    console.error('Error loading nodes:', e);
    outputNodeSelect.innerHTML='<option value="">Error loading nodes</option>';
  }
}

function populateNodeDropdown(selectEl, nodes){
  selectEl.innerHTML = '';
  
  if(!nodes || nodes.length === 0){
    selectEl.innerHTML = '<option value="">No nodes yet</option>';
    return;
  }
  
  nodes.forEach(node => {
    const opt = document.createElement('option');
    opt.value = node.node_id;
    
    const indent = '　'.repeat(node.depth);
    
    const statusEmoji = {
      'pending': '⏳',
      'planning': '🧠',
      'working': '⚙️',
      'completed': '✅',
      'failed': '❌',
      'cancelled': '🚫',
      'impossible': '⛔'
    }[node.status] || '◯';
    
    const abstractShort = node.abstract.length > 50 
      ? node.abstract.substring(0, 50) + '...' 
      : node.abstract;
    
    opt.textContent = `${indent}${statusEmoji} ${abstractShort}`;
    opt.className = `depth-${node.depth}`;
    
    selectEl.appendChild(opt);
  });
}

// Main start function
async function handleStart(){
  console.log('handleStart called, task=', task);
  
  if(!task){
    const txt=input.value.trim();
    if(!txt){
      msg('⚠ Enter a task description','#ff9800');
      return;
    }
    
    msg('🔄 Translating task...');
    startBtn.disabled=true;
    
    try{
      console.log('Calling /translate with:', txt);
      const r=await fetch('/translate',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({request:txt})
      });
      const d=await r.json();
      console.log('Translation response:', d);
      
      if(d.error){
        startBtn.disabled=false;
        msg('❌ '+d.error,'#f44336');
        return;
      }
      
      task=d.translated_task;
      orig={...task};
      abstract.value=task.abstract;
      description.value=task.description;
      verification.value=task.verification;
      taskCard.style.display='block';
      startBtn.disabled=false;
      startBtn.innerHTML='▶️ Execute Task';
      msg('✅ Task translated! Edit fields if needed, then click Execute','#4caf50');
      
    }catch(e){
      console.error('Translation error:', e);
      startBtn.disabled=false;
      msg('❌ '+e.message,'#f44336');
    }
    return;
  }
  
  task = {
    abstract: abstract.value.trim(),
    description: description.value.trim(),
    verification: verification.value.trim()
  };
  
  if(!task.abstract || !task.description || !task.verification){
    msg('⚠ All fields are required','#ff9800');
    return;
  }
  
  msg('⏳ Creating task...');
  startBtn.disabled=true;
  
  try{
    console.log('Creating task with:', task);
    const r=await fetch('/task',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({translated_task:task})
    });
    const d=await r.json();
    console.log('Task creation response:', d);
    
    if(d.error){
      startBtn.disabled=false;
      msg('❌ '+d.error,'#f44336');
      return;
    }
    
    curTask=d.task_id;
    graphId.value=outputTaskId.value=curTask;
    
    await loadOutputNodes();
    
    msg('✅ Task '+curTask+' running','#4caf50');
    switchTab('output');
    startAuto();
    loadTasks();
    
  }catch(e){
    console.error('Task creation error:', e);
    startBtn.disabled=false;
    msg('❌ '+e.message,'#f44336');
  }
}

function handleReset(){
  Object.values(intervals).forEach(i=>i&&clearInterval(i));
  task=orig=null;
  curTask=null;
  nodeCache={};
  input.value='';
  abstract.value='';
  description.value='';
  verification.value='';
  taskCard.style.display='none';
  outputNodeSelect.innerHTML='<option value="">Select task first...</option>';
  startBtn.disabled=false;
  startBtn.innerHTML='▶️ Start';
  msg('🔄 Reset');
  fetch('/reset',{method:'POST'});
}

async function loadTasks(){
  try{
    const r=await fetch('/task/status');
    const d=await r.json();
    if(d.error)return taskList.innerHTML='<div style="color:#f44336;padding:20px">'+d.error+'</div>';
    const roots=d.tasks.filter(t=>t.type==='root');
    const nodes=d.tasks.filter(t=>t.type==='node');
    count.textContent=roots.length+' task(s), '+nodes.length+' node(s)';
    if(!roots.length)return taskList.innerHTML='<div style="color:#999;padding:40px;text-align:center">No tasks yet</div>';
    taskList.innerHTML='';
    
    roots.forEach(t=>{
      const div=document.createElement('div');
      div.className='task '+t.status;
      
      // Debug log
      console.log('Task:', t.task_id, 'Status:', t.status, 'Restartable:', t.is_restartable);
      
      // Determine button states
      const canImprove = t.status==='failed' || t.status==='cancelled' || t.status==='impossible' || t.status==='completed';
      const canCancel = t.status==='working' || t.status==='planning' || t.status==='pending';
      
      div.innerHTML=`
        <div class="task-header">
          <span style="font-family:monospace">🎯 ${t.task_id}</span>
          <span class="badge">${t.status}</span>
        </div>
        <div style="font-weight:600;margin-bottom:8px">${t.abstract}</div>
        <div class="controls">
          <button class="btn-primary" onclick="viewTask('${t.task_id}',event)">👁 View</button>
          <button class="btn-warning" onclick="cancelTask('${t.task_id}',event)" ${canCancel?'':'disabled'} title="${canCancel?'Cancel this task':'Task must be running'}">⏸ Cancel</button>
          <button class="btn-success" onclick="completeTask('${t.task_id}',event)">✅ Complete</button>
          <button class="btn-info" onclick="showTaskImprove('${t.task_id}',event)" ${canImprove?'':'disabled'} title="${canImprove?'Restart with improvements':'Task must be completed or failed'}">💡 Improve</button>
        </div>
      `;
      taskList.appendChild(div);
      
      nodes.filter(n=>n.task_id===t.task_id).forEach(n=>{
        const nd=document.createElement('div');
        nd.className='task node '+n.status;
        
        // Debug log
        console.log('Node:', n.node_id, 'Status:', n.status, 'Restartable:', n.is_restartable);
        
        // Determine button states
        const canStart = n.status==='pending' || n.status==='cancelled' || n.status==='failed';
        const canImprove = n.status==='failed' || n.status==='cancelled' || n.status==='impossible';
        const canCancel = n.status==='working' || n.status==='planning' || n.status==='pending';
        
        nd.innerHTML=`
          <div class="task-header">
            <span style="font-family:monospace">📦 ${n.node_id}</span>
            <span class="badge">${n.status}</span>
          </div>
          <div style="margin-bottom:8px">${n.abstract}</div>
          <div class="controls">
            <button class="btn-primary" onclick="viewNode('${n.node_id}',event)">👁 View</button>
            <button class="btn-warning" onclick="cancelNode('${n.node_id}',event)" ${canCancel?'':'disabled'}>⏸ Cancel</button>
            <button class="btn-success" onclick="completeNode('${n.node_id}',event)">✅ Complete</button>
            <button class="btn-info" onclick="forceStartNode('${n.node_id}',event)" ${canStart?'':'disabled'} title="${canStart?'Force start this node':'Node must be pending, cancelled, or failed'}">▶️ Start</button>
            <button class="btn-info" onclick="showNodeImprove('${n.node_id}',event)" ${canImprove?'':'disabled'} title="${canImprove?'Restart with improvements':'Node must be failed, cancelled, or impossible'}">💡 Improve</button>
            <button class="btn-danger" onclick="removeNode('${n.node_id}',event)">🗑 Remove</button>
          </div>
        `;
        taskList.appendChild(nd);
      });
    });
  }catch(e){taskList.innerHTML='<div style="color:#f44336">Error: '+e.message+'</div>'}
}

async function viewTask(id,e){
  e.stopPropagation();
  graphId.value=outputTaskId.value=id;
  await loadOutputNodes();
  await loadGraph();
  switchTab('graph');
}

async function viewNode(id,e){
  e.stopPropagation();
  try{
    const r=await fetch('/node/'+id);
    const d=await r.json();
    alert('Node: '+id+'\nStatus: '+d.status+'\nAbstract: '+d.abstract+'\n\nTerminal Outputs: '+d.terminal_output.length+'\nLLM Responses: '+d.llm_responses.length);
  }catch(e){msg('❌ '+e.message,'#f44336')}
}

async function cancelTask(id,e){
  e.stopPropagation();
  if(!confirm('Cancel task '+id+' and all its nodes?'))return;
  try{
    const r=await fetch('/task/'+id+'/cancel',{method:'PUT'});
    const d=await r.json();
    msg(d.error?'❌ '+d.error:'✅ Cancelled '+id,d.error?'#f44336':'#4caf50');
    loadTasks();
  }catch(e){msg('❌ '+e.message,'#f44336')}
}

async function cancelNode(id,e){
  e.stopPropagation();
  if(!confirm('Cancel node '+id+'?'))return;
  try{
    const r=await fetch('/node/'+id+'/cancel',{method:'PUT'});
    const d=await r.json();
    msg(d.error?'❌ '+d.error:'✅ Cancelled '+id,d.error?'#f44336':'#4caf50');
    loadTasks();
  }catch(e){msg('❌ '+e.message,'#f44336')}
}

async function completeTask(id,e){
  e.stopPropagation();
  if(!confirm('Mark task '+id+' as completed?'))return;
  try{
    const r=await fetch('/task/'+id+'/complete',{method:'PUT'});
    const d=await r.json();
    msg(d.error?'❌ '+d.error:'✅ Completed '+id,d.error?'#f44336':'#4caf50');
    loadTasks();
  }catch(e){msg('❌ '+e.message,'#f44336')}
}

async function completeNode(id,e){
  e.stopPropagation();
  if(!confirm('Mark node '+id+' as completed?'))return;
  try{
    const r=await fetch('/node/'+id+'/complete',{method:'PUT'});
    const d=await r.json();
    msg(d.error?'❌ '+d.error:'✅ Completed '+id,d.error?'#f44336':'#4caf50');
    loadTasks();
  }catch(e){msg('❌ '+e.message,'#f44336')}
}

async function forceStartNode(id,e){
  e.stopPropagation();
  if(!confirm('Force start node '+id+'?'))return;
  try{
    const r=await fetch('/node/'+id+'/start',{method:'POST'});
    const d=await r.json();
    msg(d.error?'❌ '+d.error:'✅ Started '+id,d.error?'#f44336':'#4caf50');
    loadTasks();
  }catch(e){msg('❌ '+e.message,'#f44336')}
}

async function removeNode(id,e){
  e.stopPropagation();
  if(!confirm('Remove node '+id+' and its subtree?'))return;
  try{
    const r=await fetch('/node/'+id+'/remove',{method:'DELETE'});
    const d=await r.json();
    msg(d.error?'❌ '+d.error:'✅ Removed '+id,d.error?'#f44336':'#4caf50');
    loadTasks();
  }catch(e){msg('❌ '+e.message,'#f44336')}
}

function showTaskImprove(id,e){
  e.stopPropagation();
  improveTaskId=id;
  improveTaskComments.value='';
  improveTaskModal.classList.add('active');
}

function showNodeImprove(id,e){
  e.stopPropagation();
  improveNodeId=id;
  improveNodeComments.value='';
  improveNodeModal.classList.add('active');
}

async function submitTaskImprovement(){
  if(!improveTaskId)return;
  
  const comments=improveTaskComments.value.trim();
  
  try{
    const r=await fetch('/task/'+improveTaskId+'/restart',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({comments:comments})
    });
    const d=await r.json();
    
    if(d.error){
      msg('❌ '+d.error,'#f44336');
    }else{
      msg('✅ Restarted as '+d.new_task_id+(comments?' with improvements':''),'#4caf50');
      curTask=d.new_task_id;
      graphId.value=outputTaskId.value=d.new_task_id;
      await loadOutputNodes();
      switchTab('output');
      startAuto();
    }
    
    improveTaskModal.classList.remove('active');
    improveTaskId=null;
    loadTasks();
    
  }catch(e){
    msg('❌ '+e.message,'#f44336');
  }
}

async function submitNodeImprovement(){
  if(!improveNodeId)return;
  
  const comments=improveNodeComments.value.trim();
  
  try{
    const r=await fetch('/node/'+improveNodeId+'/restart',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({comments:comments})
    });
    const d=await r.json();
    
    if(d.error){
      msg('❌ '+d.error,'#f44336');
    }else{
      msg('✅ Node restarted as '+d.new_node_id+(comments?' with improvements':''),'#4caf50');
    }
    
    improveNodeModal.classList.remove('active');
    improveNodeId=null;
    loadTasks();
    loadGraph();
    
  }catch(e){
    msg('❌ '+e.message,'#f44336');
  }
}

async function loadGraph(){
  const id=graphId.value.trim();
  if(!id)return msg('⚠ Enter task ID','#ff9800');
  try{
    const r=await fetch('/tree?task_id='+id);
    const d=await r.json();
    if(d.error)return graphView.innerHTML='<div style="color:#f44336;padding:20px">'+d.error+'</div>';
    
    let graph = d.graph;
    if(!graph.includes('%%{init:')){
      graph = `%%{init: {'theme':'dark', 'themeVariables': {
        'primaryColor': '#2d2d2d',
        'primaryTextColor': '#e0e0e0',
        'primaryBorderColor': '#64b5f6',
        'lineColor': '#64b5f6',
        'secondaryColor': '#1e3a5f',
        'tertiaryColor': '#3d2f1f',
        'background': '#1a1a1a',
        'mainBkg': '#2d2d2d',
        'secondBkg': '#3d3d3d',
        'mainContrastColor': '#e0e0e0',
        'darkMode': true,
        'fontFamily': 'Arial',
        'fontSize': '14px'
      }}}%%\n` + graph;
    }
    
    graphView.innerHTML='<div class="mermaid">'+graph+'</div>';
    mermaid.init(undefined,graphView.querySelector('.mermaid'));
  }catch(e){graphView.innerHTML='<div style="color:#f44336">'+e.message+'</div>'}
}

async function loadOutput(){
  const nodeId = outputNodeSelect.value;
  if(!nodeId){
    return;
  }
  
  try{
    const r = await fetch('/node/'+nodeId+'/log');
    const d = await r.json();
    
    if(d.error){
      outputView.textContent = d.error;
      return;
    }
    
    outputView.textContent = d.log;
    outputView.scrollTop = outputView.scrollHeight;
    
  }catch(e){
    outputView.textContent = 'Error: ' + e.message;
  }
}

function toggleAuto(type){
  auto[type]=!auto[type];
  const btn=type==='graph'?graphAuto:outputAuto;
  btn.textContent='Auto: '+(auto[type]?'ON':'OFF');
  btn.className=auto[type]?'btn-success':'btn-primary';
  
  if(auto[type]){
    if(type==='graph'){
      intervals.graph=setInterval(loadGraph,3000);
    }else if(type==='output'){
      intervals.output=setInterval(loadOutput,3000);
      intervals.outputNodes=setInterval(loadOutputNodes,5000);
    }
  }else{
    if(type==='graph' && intervals.graph){
      clearInterval(intervals.graph);
      intervals.graph=null;
    }else if(type==='output'){
      if(intervals.output){clearInterval(intervals.output);intervals.output=null;}
      if(intervals.outputNodes){clearInterval(intervals.outputNodes);intervals.outputNodes=null;}
    }
  }
}

function startAuto(){
  auto.graph=auto.output=true;
  
  graphAuto.textContent='Auto: ON';
  graphAuto.className='btn-success';
  intervals.graph=setInterval(loadGraph,3000);
  
  outputAuto.textContent='Auto: ON';
  outputAuto.className='btn-success';
  intervals.output=setInterval(loadOutput,3000);
  intervals.outputNodes=setInterval(loadOutputNodes,5000);
  
  intervals.poll=setInterval(async()=>{
    try{
      const r=await fetch('/task/'+curTask);
      const d=await r.json();
      if(['completed','failed','cancelled','impossible'].includes(d.status)){
        Object.values(intervals).forEach(i=>i&&clearInterval(i));
        loadOutput();
        loadGraph();
        loadTasks();
        msg('✅ Task '+d.status,d.status==='completed'?'#4caf50':'#f44336');
      }
    }catch(e){}
  },3000);
}

async function loadFiles(p){
  curPath=p;
  path.textContent=p;
  upBtn.style.display=(p!=='/app/work'&&p!=='/app'&&p!=='/')?'block':'none';
  fileView.style.display='none';
  try{
    const r=await fetch('/files?path='+encodeURIComponent(p));
    const d=await r.json();
    if(d.error)return fileGrid.innerHTML='<div style="grid-column:1/-1;color:#f44336">'+d.error+'</div>';
    if(!d.files.length)return fileGrid.innerHTML='<div style="grid-column:1/-1;text-align:center;color:#999;padding:40px">Empty</div>';
    fileGrid.innerHTML='';
    d.files.sort((a,b)=>a.type===b.type?a.name.localeCompare(b.name):a.type==='directory'?-1:1).forEach(f=>{
      const c=document.createElement('div');
      c.className='file-card '+(f.type==='directory'?'dir':'file');
      const icon=f.type==='directory'?'📁':f.name.endsWith('.txt')?'📄':f.name.endsWith('.log')?'📋':f.name.endsWith('.json')?'📊':'📄';
      c.innerHTML='<div class="icon">'+icon+'</div><div style="font-weight:600;font-size:13px;word-break:break-word">'+f.name+'</div><div style="font-size:11px;color:#999;margin-top:5px">'+f.size+'</div>';
      c.onclick=()=>f.type==='directory'?loadFiles(f.full_path):viewFile(f.full_path);
      fileGrid.appendChild(c);
    });
  }catch(e){fileGrid.innerHTML='<div style="grid-column:1/-1;color:#f44336">'+e.message+'</div>'}
}

function goUp(){
  loadFiles(curPath.split('/').slice(0,-1).join('/')||'/');
}

async function viewFile(p){
  fileView.style.display='block';
  fileView.innerHTML='<div style="text-align:center;color:#999">Loading...</div>';
  try{
    const r=await fetch('/file?path='+encodeURIComponent(p));
    const d=await r.json();
    if(d.error)return fileView.innerHTML='<div style="color:#f44336">'+d.error+'</div>';
    const name=p.split('/').pop();
    fileView.innerHTML='<h3>📄 '+name+'</h3><button class="btn-primary" onclick="copyFile()">📋 Copy</button> <button class="btn-danger" onclick="fileView.style.display=\'none\'">✖ Close</button><pre id="fc">'+esc(d.content)+'</pre>';
  }catch(e){fileView.innerHTML='<div style="color:#f44336">'+e.message+'</div>'}
}

function copyFile(){
  const fc=document.getElementById('fc');
  navigator.clipboard.writeText(fc.textContent).then(()=>msg('📋 Copied!','#4caf50')).catch(()=>msg('❌ Copy failed','#f44336'));
}

function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}
</script>
</body>
</html>