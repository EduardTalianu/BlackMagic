<!doctype html>
<html>
<head>
<title>Kali-LLM Task Manager</title>
<style>
*{box-sizing:border-box}
:root{
  --bg:#1a1a1a;--fg:#e0e0e0;--card-bg:#2d2d2d;--card-border:#444;
  --input-bg:#1a1a1a;--input-border:#555;--status-bg:#2d2d2d;
  --tab-inactive:#aaa;--tab-active:#64b5f6;--task-bg:#2d2d2d;
  --hover-bg:#3d3d3d;--grid-border:#444;--badge-bg:#3d3d3d;
}
body{font-family:Arial,sans-serif;margin:0;padding:1rem;height:100vh;overflow:hidden;background:var(--bg);color:var(--fg);transition:all 0.3s}
.container{display:flex;gap:20px;height:calc(100vh - 2rem)}
.left{flex:0 0 400px;display:flex;flex-direction:column;gap:10px}
.right{flex:1;display:flex;flex-direction:column;min-width:0}
.card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:8px;padding:15px}
.card h3{margin:0 0 10px 0;font-size:16px;color:var(--fg)}
textarea{width:100%;padding:8px;border:1px solid var(--input-border);border-radius:4px;font-family:inherit;resize:vertical;background:var(--input-bg);color:var(--fg)}
textarea:focus{outline:none;border-color:#64b5f6}
button{padding:8px 16px;border:none;border-radius:4px;cursor:pointer;font-size:14px;font-weight:500}
button:disabled{opacity:0.5;cursor:not-allowed}
.btn-primary{background:#2196f3;color:#fff}
.btn-success{background:#4caf50;color:#fff}
.btn-danger{background:#f44336;color:#fff}
.btn-warning{background:#ff9800;color:#fff}
button:hover:not(:disabled){opacity:0.9}
.btn-group{display:flex;gap:8px}
.tabs{display:flex;border-bottom:2px solid var(--grid-border);margin-bottom:10px}
.tab{padding:10px 20px;cursor:pointer;border-bottom:3px solid transparent;margin-bottom:-2px;font-weight:500;color:var(--tab-inactive)}
.tab.active{color:var(--tab-active);border-bottom-color:var(--tab-active)}
.tab-content{display:none;flex:1;overflow:auto}
.tab-content.active{display:flex;flex-direction:column}
.status{padding:10px;margin:10px 0;border-radius:4px;background:var(--status-bg);border-left:3px solid #2196f3}
.task{padding:12px;margin:8px 0;border:1px solid var(--card-border);border-radius:6px;border-left:4px solid #ccc;cursor:pointer;transition:all 0.2s;background:var(--task-bg)}
.task:hover{background:var(--hover-bg);transform:translateX(2px)}
.task.working{border-left-color:#ff9800}
.task.completed{border-left-color:#4caf50}
.task.failed{border-left-color:#f44336}
.task.planning{border-left-color:#2196f3}
.task-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.badge{padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;text-transform:uppercase;background:var(--badge-bg)}
.node{margin-left:30px;border-left-color:#999}
.controls{display:flex;gap:5px;margin-top:8px}
.controls button{padding:4px 10px;font-size:12px}
.file-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
.file-card{padding:20px;border:2px solid var(--grid-border);border-radius:8px;text-align:center;cursor:pointer;transition:all 0.2s;background:var(--card-bg)}
.file-card:hover{border-color:#2196f3;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.3)}
.file-card.dir{background:#1e3a5f}
.file-card.file{background:#3d2f1f}
.icon{font-size:36px;margin-bottom:8px}
.terminal{background:#000;color:#0f0;font-family:'Courier New',monospace;padding:15px;border-radius:6px;white-space:pre-wrap;overflow:auto;flex:1}
input[type=text]{padding:8px;border:1px solid var(--input-border);border-radius:4px;background:var(--input-bg);color:var(--fg)}
input[type=text]:focus{outline:none;border-color:#64b5f6}
select{padding:8px;border:1px solid var(--input-border);border-radius:4px;background:var(--input-bg);color:var(--fg);font-size:14px;min-width:200px}
select:focus{outline:none;border-color:#64b5f6}
option{background:var(--card-bg);color:var(--fg);padding:8px}
option.depth-1{padding-left:20px}
option.depth-2{padding-left:40px}
option.depth-3{padding-left:60px}
option.depth-4{padding-left:80px}
.toolbar{display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
.field{margin-bottom:12px}
.field label{display:block;font-weight:600;margin-bottom:4px;color:var(--fg)}
.field textarea{min-height:50px}
.field.description textarea{min-height:80px}
.viewer{background:var(--status-bg);padding:15px;border-radius:6px;margin-top:10px}
.viewer pre{background:var(--card-bg);padding:15px;border-radius:4px;overflow-x:auto;margin:10px 0;border:1px solid var(--card-border);color:var(--fg)}
.quick-nav{display:flex;gap:10px;margin-bottom:10px}
.quick-nav button{padding:6px 12px;font-size:13px}
</style>
</head>
<body>
<div class="container">
  <div class="left">
    <div class="card">
      <h3>üìù Task Input</h3>
      <textarea id="input" rows="6" placeholder="Example: Perform recon on domain example.com&#10;&#10;Press Enter or click Start to begin"></textarea>
      <div class="btn-group" style="margin-top:10px">
        <button class="btn-success" id="startBtn">‚ñ∂Ô∏è Start</button>
        <button class="btn-danger" id="resetBtn">üîÑ Reset</button>
      </div>
    </div>
    
    <div class="card" id="taskCard" style="display:none">
      <h3>‚úèÔ∏è Task Configuration</h3>
      <div class="field">
        <label>Abstract</label>
        <textarea id="abstract"></textarea>
      </div>
      <div class="field description">
        <label>Description</label>
        <textarea id="description"></textarea>
      </div>
      <div class="field">
        <label>Verification</label>
        <textarea id="verification"></textarea>
      </div>
    </div>
    
    <div class="status" id="status"></div>
  </div>
  
  <div class="right card">
    <div class="tabs">
      <div class="tab active" data-tab="tasks">üìã Tasks</div>
      <div class="tab" data-tab="graph">üå≥ Graph</div>
      <div class="tab" data-tab="terminal">üíª Terminal</div>
      <div class="tab" data-tab="llm">ü§ñ LLM</div>
      <div class="tab" data-tab="files">üìÅ Files</div>
    </div>
    
    <div id="tasks" class="tab-content active">
      <div class="toolbar">
        <button class="btn-primary" id="refreshTasksBtn">üîÑ Refresh</button>
        <span id="count"></span>
      </div>
      <div id="taskList"></div>
    </div>
    
    <div id="graph" class="tab-content">
      <div class="toolbar">
        <input type="text" id="graphId" placeholder="Task ID">
        <button class="btn-primary" id="loadGraphBtn">Load</button>
        <button id="graphAuto" class="btn-primary">Auto: OFF</button>
      </div>
      <div id="graphView" style="flex:1;overflow:auto;background:#1a1a1a;padding:10px"></div>
    </div>
    
    <div id="terminal" class="tab-content">
      <div class="toolbar">
        <input type="text" id="termTaskId" placeholder="Task ID" style="width:150px">
        <select id="termNodeSelect" style="flex:1;max-width:400px">
          <option value="">Select task first...</option>
        </select>
        <button class="btn-primary" id="loadTermBtn">üîÑ Refresh</button>
        <button id="termAuto" class="btn-primary">Auto: OFF</button>
      </div>
      <div id="termView" class="terminal"></div>
    </div>
    
    <div id="llm" class="tab-content">
      <div class="toolbar">
        <input type="text" id="llmTaskId" placeholder="Task ID" style="width:150px">
        <select id="llmNodeSelect" style="flex:1;max-width:400px">
          <option value="">Select task first...</option>
        </select>
        <button class="btn-primary" id="loadLLMBtn">üîÑ Refresh</button>
        <button id="llmAuto" class="btn-primary">Auto: OFF</button>
      </div>
      <div id="llmView" class="terminal" style="color:#ff0;background:#1a1a1a"></div>
    </div>
    
    <div id="files" class="tab-content">
      <div class="quick-nav">
        <button class="btn-primary" id="navWork">üìÇ Work</button>
        <button class="btn-primary" id="navLogs">üìã Logs</button>
        <button class="btn-primary" id="navShared">üîó Shared</button>
      </div>
      <div class="toolbar">
        <strong>üìÇ <span id="path">/app/work</span></strong>
        <button id="upBtn" class="btn-primary" style="display:none">‚¨Ü Up</button>
      </div>
      <div id="fileGrid" class="file-grid"></div>
      <div id="fileView" class="viewer" style="display:none"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
mermaid.initialize({startOnLoad:false,theme:'dark'});

// Global state
let task=null,orig=null,curPath='/app/work',curTask=null;
let intervals={graph:null,term:null,llm:null,poll:null,termNodes:null,llmNodes:null};
let auto={graph:false,term:false,llm:false};
let nodeCache={};  // Cache nodes per task

// DOM element references
let input, status, startBtn, resetBtn, taskCard, abstract, description, verification;
let graphId, termTaskId, llmTaskId, termNodeSelect, llmNodeSelect;
let graphView, termView, llmView, fileGrid, fileView, path, upBtn, taskList, count;
let refreshTasksBtn, loadGraphBtn, loadTermBtn, loadLLMBtn, graphAuto, termAuto, llmAuto;
let navWork, navLogs, navShared;

function msg(t,c='#2196f3'){
  if(!status) return;
  status.innerHTML=t;
  status.style.borderLeftColor=c;
}

// Initialize on DOM load
document.addEventListener('DOMContentLoaded',()=>{
  console.log('DOM loaded, initializing...');
  
  // Initialize all element references
  input = document.getElementById('input');
  status = document.getElementById('status');
  startBtn = document.getElementById('startBtn');
  resetBtn = document.getElementById('resetBtn');
  taskCard = document.getElementById('taskCard');
  abstract = document.getElementById('abstract');
  description = document.getElementById('description');
  verification = document.getElementById('verification');
  graphId = document.getElementById('graphId');
  termTaskId = document.getElementById('termTaskId');
  llmTaskId = document.getElementById('llmTaskId');
  termNodeSelect = document.getElementById('termNodeSelect');
  llmNodeSelect = document.getElementById('llmNodeSelect');
  graphView = document.getElementById('graphView');
  termView = document.getElementById('termView');
  llmView = document.getElementById('llmView');
  fileGrid = document.getElementById('fileGrid');
  fileView = document.getElementById('fileView');
  path = document.getElementById('path');
  upBtn = document.getElementById('upBtn');
  taskList = document.getElementById('taskList');
  count = document.getElementById('count');
  refreshTasksBtn = document.getElementById('refreshTasksBtn');
  loadGraphBtn = document.getElementById('loadGraphBtn');
  loadTermBtn = document.getElementById('loadTermBtn');
  loadLLMBtn = document.getElementById('loadLLMBtn');
  graphAuto = document.getElementById('graphAuto');
  termAuto = document.getElementById('termAuto');
  llmAuto = document.getElementById('llmAuto');
  navWork = document.getElementById('navWork');
  navLogs = document.getElementById('navLogs');
  navShared = document.getElementById('navShared');
  
  console.log('Elements initialized');
  
  // Add event listeners
  input.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&!e.shiftKey){
      e.preventDefault();
      handleStart();
    }
  });
  
  startBtn.addEventListener('click', handleStart);
  resetBtn.addEventListener('click', handleReset);
  refreshTasksBtn.addEventListener('click', loadTasks);
  loadGraphBtn.addEventListener('click', loadGraph);
  loadTermBtn.addEventListener('click', loadTerminal);
  loadLLMBtn.addEventListener('click', loadLLM);
  graphAuto.addEventListener('click', ()=>toggleAuto('graph'));
  termAuto.addEventListener('click', ()=>toggleAuto('term'));
  llmAuto.addEventListener('click', ()=>toggleAuto('llm'));
  upBtn.addEventListener('click', goUp);
  navWork.addEventListener('click', ()=>loadFiles('/app/work'));
  navLogs.addEventListener('click', ()=>loadFiles('/app/logs'));
  navShared.addEventListener('click', ()=>loadFiles('/shared'));
  
  // Task ID change listeners for dropdowns
  termTaskId.addEventListener('change', loadTerminalNodes);
  llmTaskId.addEventListener('change', loadLLMNodes);
  
  // Node selection change listeners - auto-load when node selected
  termNodeSelect.addEventListener('change', loadTerminal);
  llmNodeSelect.addEventListener('change', loadLLM);
  
  // Tab switching
  document.querySelectorAll('.tab').forEach(tab=>{
    tab.addEventListener('click', function(){
      const tabName = this.getAttribute('data-tab');
      switchTab(tabName);
    });
  });
  
  console.log('Event listeners attached');
  msg('Ready to start');
  loadTasks();
});

function switchTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${name}"]`).classList.add('active');
  document.getElementById(name).classList.add('active');
  if(name==='files')loadFiles(curPath);
  else if(name==='tasks')loadTasks();
}

// Node dropdown population
async function loadTerminalNodes(){
  const taskId = termTaskId.value.trim();
  if(!taskId){
    termNodeSelect.innerHTML='<option value="">Select task first...</option>';
    return;
  }
  
  // Remember currently selected node
  const currentSelection = termNodeSelect.value;
  const hadSelection = currentSelection && currentSelection !== '';
  
  try{
    const r = await fetch('/task/'+taskId+'/nodes');
    const d = await r.json();
    
    if(d.error){
      termNodeSelect.innerHTML='<option value="">Error loading nodes</option>';
      return;
    }
    
    nodeCache[taskId] = d.nodes;
    populateNodeDropdown(termNodeSelect, d.nodes);
    
    // Restore previous selection if it still exists
    if(hadSelection){
      const optionExists = Array.from(termNodeSelect.options).some(opt => opt.value === currentSelection);
      if(optionExists){
        termNodeSelect.value = currentSelection;
      }
    } else if(d.nodes.length > 0) {
      // Auto-select first node if no previous selection
      termNodeSelect.value = d.nodes[0].node_id;
      // Auto-load the first node
      await loadTerminal();
    }
    
  }catch(e){
    console.error('Error loading nodes:', e);
    termNodeSelect.innerHTML='<option value="">Error loading nodes</option>';
  }
}

async function loadLLMNodes(){
  const taskId = llmTaskId.value.trim();
  if(!taskId){
    llmNodeSelect.innerHTML='<option value="">Select task first...</option>';
    return;
  }
  
  // Remember currently selected node
  const currentSelection = llmNodeSelect.value;
  const hadSelection = currentSelection && currentSelection !== '';
  
  try{
    const r = await fetch('/task/'+taskId+'/nodes');
    const d = await r.json();
    
    if(d.error){
      llmNodeSelect.innerHTML='<option value="">Error loading nodes</option>';
      return;
    }
    
    nodeCache[taskId] = d.nodes;
    populateNodeDropdown(llmNodeSelect, d.nodes);
    
    // Restore previous selection if it still exists
    if(hadSelection){
      const optionExists = Array.from(llmNodeSelect.options).some(opt => opt.value === currentSelection);
      if(optionExists){
        llmNodeSelect.value = currentSelection;
      }
    } else if(d.nodes.length > 0) {
      // Auto-select first node if no previous selection
      llmNodeSelect.value = d.nodes[0].node_id;
      // Auto-load the first node
      await loadLLM();
    }
    
  }catch(e){
    console.error('Error loading nodes:', e);
    llmNodeSelect.innerHTML='<option value="">Error loading nodes</option>';
  }
}

function populateNodeDropdown(selectEl, nodes){
  selectEl.innerHTML = '';
  
  if(!nodes || nodes.length === 0){
    selectEl.innerHTML = '<option value="">No nodes yet</option>';
    return;
  }
  
  // Add each node with indentation based on depth
  nodes.forEach(node => {
    const opt = document.createElement('option');
    opt.value = node.node_id;
    
    // Create indentation
    const indent = '„ÄÄ'.repeat(node.depth);  // Japanese space for better visual
    
    // Status emoji
    const statusEmoji = {
      'pending': '‚è≥',
      'planning': 'üß†',
      'working': '‚öôÔ∏è',
      'completed': '‚úÖ',
      'failed': '‚ùå',
      'cancelled': 'üö´',
      'impossible': '‚õî'
    }[node.status] || '‚óØ';
    
    // Truncate abstract for dropdown
    const abstractShort = node.abstract.length > 50 
      ? node.abstract.substring(0, 50) + '...' 
      : node.abstract;
    
    opt.textContent = `${indent}${statusEmoji} ${abstractShort}`;
    opt.className = `depth-${node.depth}`;
    
    selectEl.appendChild(opt);
  });
}

// Main start function
async function handleStart(){
  console.log('handleStart called, task=', task);
  
  // Step 1: Translate if no task exists
  if(!task){
    const txt=input.value.trim();
    if(!txt){
      msg('‚ö† Enter a task description','#ff9800');
      return;
    }
    
    msg('üîÑ Translating task...');
    startBtn.disabled=true;
    
    try{
      console.log('Calling /translate with:', txt);
      const r=await fetch('/translate',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({request:txt})
      });
      const d=await r.json();
      console.log('Translation response:', d);
      
      if(d.error){
        startBtn.disabled=false;
        msg('‚ùå '+d.error,'#f44336');
        return;
      }
      
      task=d.translated_task;
      orig={...task};
      abstract.value=task.abstract;
      description.value=task.description;
      verification.value=task.verification;
      taskCard.style.display='block';
      startBtn.disabled=false;
      startBtn.innerHTML='‚ñ∂Ô∏è Execute Task';
      msg('‚úÖ Task translated! Edit fields if needed, then click Execute','#4caf50');
      
    }catch(e){
      console.error('Translation error:', e);
      startBtn.disabled=false;
      msg('‚ùå '+e.message,'#f44336');
    }
    return;
  }
  
  // Step 2: Execute the task
  task = {
    abstract: abstract.value.trim(),
    description: description.value.trim(),
    verification: verification.value.trim()
  };
  
  if(!task.abstract || !task.description || !task.verification){
    msg('‚ö† All fields are required','#ff9800');
    return;
  }
  
  msg('‚è≥ Creating task...');
  startBtn.disabled=true;
  
  try{
    console.log('Creating task with:', task);
    const r=await fetch('/task',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({translated_task:task})
    });
    const d=await r.json();
    console.log('Task creation response:', d);
    
    if(d.error){
      startBtn.disabled=false;
      msg('‚ùå '+d.error,'#f44336');
      return;
    }
    
    curTask=d.task_id;
    graphId.value=termTaskId.value=llmTaskId.value=curTask;
    
    // Load nodes for dropdowns
    await loadTerminalNodes();
    await loadLLMNodes();
    
    msg('‚úÖ Task '+curTask+' running','#4caf50');
    switchTab('terminal');
    startAuto();
    loadTasks();
    
  }catch(e){
    console.error('Task creation error:', e);
    startBtn.disabled=false;
    msg('‚ùå '+e.message,'#f44336');
  }
}

function handleReset(){
  Object.values(intervals).forEach(i=>i&&clearInterval(i));
  task=orig=null;
  curTask=null;
  nodeCache={};
  input.value='';
  abstract.value='';
  description.value='';
  verification.value='';
  taskCard.style.display='none';
  termNodeSelect.innerHTML='<option value="">Select task first...</option>';
  llmNodeSelect.innerHTML='<option value="">Select task first...</option>';
  startBtn.disabled=false;
  startBtn.innerHTML='‚ñ∂Ô∏è Start';
  msg('üîÑ Reset');
  fetch('/reset',{method:'POST'});
}

async function loadTasks(){
  try{
    const r=await fetch('/task/status');
    const d=await r.json();
    if(d.error)return taskList.innerHTML='<div style="color:#f44336;padding:20px">'+d.error+'</div>';
    const roots=d.tasks.filter(t=>t.type==='root');
    const nodes=d.tasks.filter(t=>t.type==='node');
    count.textContent=roots.length+' task(s), '+nodes.length+' node(s)';
    if(!roots.length)return taskList.innerHTML='<div style="color:#999;padding:40px;text-align:center">No tasks yet</div>';
    taskList.innerHTML='';
    roots.forEach(t=>{
      const div=document.createElement('div');
      div.className='task '+t.status;
      div.innerHTML=`<div class="task-header"><span style="font-family:monospace">üéØ ${t.task_id}</span><span class="badge">${t.status}</span></div><div style="font-weight:600">${t.abstract}</div>`;
      div.onclick=()=>viewTask(t.task_id);
      taskList.appendChild(div);
      nodes.filter(n=>n.task_id===t.task_id).forEach(n=>{
        const nd=document.createElement('div');
        nd.className='task node '+n.status;
        nd.innerHTML=`<div class="task-header"><span style="font-family:monospace">üì¶ ${n.node_id}</span><span class="badge">${n.status}</span></div><div>${n.abstract}</div><div class="controls"><button class="btn-primary" onclick="viewNode('${n.node_id}',event)">üëÅ</button><button class="btn-warning" onclick="stopNode('${n.node_id}',event)">‚è∏</button><button class="btn-danger" onclick="delNode('${n.node_id}',event)">üóë</button></div>`;
        taskList.appendChild(nd);
      });
    });
  }catch(e){taskList.innerHTML='<div style="color:#f44336">Error: '+e.message+'</div>'}
}

async function viewTask(id){
  graphId.value=termTaskId.value=llmTaskId.value=id;
  await loadTerminalNodes();
  await loadLLMNodes();
  await loadGraph();
  switchTab('graph');
}

async function viewNode(id,e){
  e.stopPropagation();
  try{
    const r=await fetch('/node/'+id);
    const d=await r.json();
    alert('Node: '+id+'\nStatus: '+d.status+'\nAbstract: '+d.abstract+'\n\nOutputs: '+d.terminal_output.length+'\nLLM: '+d.llm_responses.length);
  }catch(e){msg('‚ùå '+e.message,'#f44336')}
}

async function stopNode(id,e){
  e.stopPropagation();
  if(!confirm('Stop node '+id+'?'))return;
  try{
    const r=await fetch('/node/'+id+'/stop',{method:'PUT'});
    const d=await r.json();
    msg(d.error?'‚ùå '+d.error:'‚úÖ Stopped '+id,d.error?'#f44336':'#4caf50');
    loadTasks();
  }catch(e){msg('‚ùå '+e.message,'#f44336')}
}

async function delNode(id,e){
  e.stopPropagation();
  if(!confirm('Remove node '+id+'?'))return;
  try{
    const r=await fetch('/node/'+id+'/remove',{method:'DELETE'});
    const d=await r.json();
    msg(d.error?'‚ùå '+d.error:'‚úÖ Removed '+id,d.error?'#f44336':'#4caf50');
    loadTasks();
  }catch(e){msg('‚ùå '+e.message,'#f44336')}
}

async function loadGraph(){
  const id=graphId.value.trim();
  if(!id)return msg('‚ö† Enter task ID','#ff9800');
  try{
    const r=await fetch('/tree?task_id='+id);
    const d=await r.json();
    if(d.error)return graphView.innerHTML='<div style="color:#f44336;padding:20px">'+d.error+'</div>';
    
    let graph = d.graph;
    if(!graph.includes('%%{init:')){
      graph = `%%{init: {'theme':'dark', 'themeVariables': {
        'primaryColor': '#2d2d2d',
        'primaryTextColor': '#e0e0e0',
        'primaryBorderColor': '#64b5f6',
        'lineColor': '#64b5f6',
        'secondaryColor': '#1e3a5f',
        'tertiaryColor': '#3d2f1f',
        'background': '#1a1a1a',
        'mainBkg': '#2d2d2d',
        'secondBkg': '#3d3d3d',
        'mainContrastColor': '#e0e0e0',
        'darkMode': true,
        'fontFamily': 'Arial',
        'fontSize': '14px'
      }}}%%\n` + graph;
    }
    
    graphView.innerHTML='<div class="mermaid">'+graph+'</div>';
    mermaid.init(undefined,graphView.querySelector('.mermaid'));
  }catch(e){graphView.innerHTML='<div style="color:#f44336">'+e.message+'</div>'}
}

async function loadTerminal(){
  const nodeId = termNodeSelect.value;
  if(!nodeId){
    // Silently return if no node selected
    return;
  }
  
  try{
    const r = await fetch('/node/'+nodeId+'/log');
    const d = await r.json();
    
    if(d.error){
      termView.textContent = d.error;
      return;
    }
    
    termView.textContent = d.log;
    termView.scrollTop = termView.scrollHeight;
    
  }catch(e){
    termView.textContent = 'Error: ' + e.message;
  }
}

async function loadLLM(){
  const nodeId = llmNodeSelect.value;
  if(!nodeId){
    // Silently return if no node selected
    return;
  }
  
  try{
    const r = await fetch('/node/'+nodeId+'/log');
    const d = await r.json();
    
    if(d.error){
      llmView.textContent = d.error;
      return;
    }
    
    llmView.textContent = d.log;
    llmView.scrollTop = llmView.scrollHeight;
    
  }catch(e){
    llmView.textContent = 'Error: ' + e.message;
  }
}

function toggleAuto(type){
  auto[type]=!auto[type];
  const btn=type==='graph'?graphAuto:type==='term'?termAuto:llmAuto;
  btn.textContent='Auto: '+(auto[type]?'ON':'OFF');
  btn.className=auto[type]?'btn-success':'btn-primary';
  
  if(auto[type]){
    if(type==='graph'){
      intervals.graph=setInterval(loadGraph,3000);
    }else if(type==='term'){
      intervals.term=setInterval(loadTerminal,3000);
      intervals.termNodes=setInterval(loadTerminalNodes,5000);
    }else if(type==='llm'){
      intervals.llm=setInterval(loadLLM,3000);
      intervals.llmNodes=setInterval(loadLLMNodes,5000);
    }
  }else{
    if(type==='graph' && intervals.graph){
      clearInterval(intervals.graph);
      intervals.graph=null;
    }else if(type==='term'){
      if(intervals.term){clearInterval(intervals.term);intervals.term=null;}
      if(intervals.termNodes){clearInterval(intervals.termNodes);intervals.termNodes=null;}
    }else if(type==='llm'){
      if(intervals.llm){clearInterval(intervals.llm);intervals.llm=null;}
      if(intervals.llmNodes){clearInterval(intervals.llmNodes);intervals.llmNodes=null;}
    }
  }
}

function startAuto(){
  // Enable auto-refresh for all tabs
  auto.graph=auto.term=auto.llm=true;
  
  graphAuto.textContent='Auto: ON';
  graphAuto.className='btn-success';
  intervals.graph=setInterval(loadGraph,3000);
  
  termAuto.textContent='Auto: ON';
  termAuto.className='btn-success';
  intervals.term=setInterval(loadTerminal,3000);
  intervals.termNodes=setInterval(loadTerminalNodes,5000);
  
  llmAuto.textContent='Auto: ON';
  llmAuto.className='btn-success';
  intervals.llm=setInterval(loadLLM,3000);
  intervals.llmNodes=setInterval(loadLLMNodes,5000);
  
  intervals.poll=setInterval(async()=>{
    try{
      const r=await fetch('/task/'+curTask);
      const d=await r.json();
      if(['completed','failed','cancelled','impossible'].includes(d.status)){
        Object.values(intervals).forEach(i=>i&&clearInterval(i));
        loadTerminal();
        loadLLM();
        loadGraph();
        loadTasks();
        msg('‚úÖ Task '+d.status,d.status==='completed'?'#4caf50':'#f44336');
      }
    }catch(e){}
  },3000);
}

async function loadFiles(p){
  curPath=p;
  path.textContent=p;
  upBtn.style.display=(p!=='/app/work'&&p!=='/app'&&p!=='/')?'block':'none';
  fileView.style.display='none';
  try{
    const r=await fetch('/files?path='+encodeURIComponent(p));
    const d=await r.json();
    if(d.error)return fileGrid.innerHTML='<div style="grid-column:1/-1;color:#f44336">'+d.error+'</div>';
    if(!d.files.length)return fileGrid.innerHTML='<div style="grid-column:1/-1;text-align:center;color:#999;padding:40px">Empty</div>';
    fileGrid.innerHTML='';
    d.files.sort((a,b)=>a.type===b.type?a.name.localeCompare(b.name):a.type==='directory'?-1:1).forEach(f=>{
      const c=document.createElement('div');
      c.className='file-card '+(f.type==='directory'?'dir':'file');
      const icon=f.type==='directory'?'üìÅ':f.name.endsWith('.txt')?'üìÑ':f.name.endsWith('.log')?'üìã':f.name.endsWith('.json')?'üìä':'üìÑ';
      c.innerHTML='<div class="icon">'+icon+'</div><div style="font-weight:600;font-size:13px;word-break:break-word">'+f.name+'</div><div style="font-size:11px;color:#999;margin-top:5px">'+f.size+'</div>';
      c.onclick=()=>f.type==='directory'?loadFiles(f.full_path):viewFile(f.full_path);
      fileGrid.appendChild(c);
    });
  }catch(e){fileGrid.innerHTML='<div style="grid-column:1/-1;color:#f44336">'+e.message+'</div>'}
}

function goUp(){
  loadFiles(curPath.split('/').slice(0,-1).join('/')||'/');
}

async function viewFile(p){
  fileView.style.display='block';
  fileView.innerHTML='<div style="text-align:center;color:#999">Loading...</div>';
  try{
    const r=await fetch('/file?path='+encodeURIComponent(p));
    const d=await r.json();
    if(d.error)return fileView.innerHTML='<div style="color:#f44336">'+d.error+'</div>';
    const name=p.split('/').pop();
    fileView.innerHTML='<h3>üìÑ '+name+'</h3><button class="btn-primary" onclick="copyFile()">üìã Copy</button> <button class="btn-danger" onclick="fileView.style.display=\'none\'">‚úñ Close</button><pre id="fc">'+esc(d.content)+'</pre>';
  }catch(e){fileView.innerHTML='<div style="color:#f44336">'+e.message+'</div>'}
}

function copyFile(){
  const fc=document.getElementById('fc');
  navigator.clipboard.writeText(fc.textContent).then(()=>msg('üìã Copied!','#4caf50')).catch(()=>msg('‚ùå Copy failed','#f44336'));
}

function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}
</script>
</body>
</html>